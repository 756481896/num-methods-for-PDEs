<!--
Automatically generated HTML file from DocOnce source
(https://github.com/hplgit/doconce/)
-->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="DocOnce: https://github.com/hplgit/doconce/" />
<meta name="description" content="Scientific software engineering with a simple ODE model as example">
<meta name="keywords" content="importing modules,list comprehension,option-value pairs (command line),command-line options and values,reading the command line,doctests,software testing doctests,unit testing,software testing nose,software testing pytest,test function,software testing test function,unit testing,software testing unit testing (class-based),problem class,solver class,wrapper (code),problem class,solver class,Unix wildcard notation,wildcard notation (Unix)">

<title>Scientific software engineering with a simple ODE model as example</title>

<!-- Bootstrap style: bootswatch_journal -->
<link href="http://netdna.bootstrapcdn.com/bootswatch/3.1.1/journal/bootstrap.min.css" rel="stylesheet">
<!-- not necessary
<link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
-->

<style type="text/css">
/* Let inline verbatim have the same color as the surroundings */
code { color: inherit; background-color: transparent; }
</style>


</head>

<!-- tocinfo
{'highest level': 1,
 'sections': [(' Basic implementations ',
               1,
               'softeng1:basic',
               'softeng1:basic'),
              (' Mathematical problem and solution technique ',
               2,
               'softeng1:basic:math',
               'softeng1:basic:math'),
              (' A first, quick implementation ',
               2,
               'softeng1:basic:impl1',
               'softeng1:basic:impl1'),
              (' Isolating the numerical algorithm in a function ',
               2,
               'softeng1:basic:func',
               'softeng1:basic:func'),
              (' Making a module ',
               2,
               'softeng1:basic:module',
               'softeng1:basic:module'),
              (' Prefixing imported functions by the module name ',
               2,
               'softeng1:basic:modprefix',
               'softeng1:basic:modprefix'),
              (' Comparing numerical schemes in one plot ',
               2,
               'softeng1:basic:experiment2',
               'softeng1:basic:experiment2'),
              (' User interfaces ', 1, None, '___sec7'),
              (' Command-line arguments ', 2, None, '___sec8'),
              (' Positional command-line arguments ', 2, None, '___sec9'),
              (' Option-value pairs on the command line ',
               2,
               None,
               '___sec10'),
              (' Creating a graphical web user interface ',
               2,
               None,
               '___sec11'),
              (' Making a compute function ', 3, None, '___sec12'),
              (' Generating the user interface ', 3, None, '___sec13'),
              (' Running the web application ', 3, None, '___sec14'),
              (' Tests for verifying implementations ', 1, None, '___sec15'),
              (' Doctests ', 2, None, '___sec16'),
              (' Unit tests and test functions ', 2, None, '___sec17'),
              (' Test frameworks: nose and pytest ', 3, None, '___sec18'),
              (' Test function requirements ', 3, None, '___sec19'),
              (' Comparison of real numbers ', 3, None, '___sec20'),
              (' Special assert functions from nose ', 3, None, '___sec21'),
              (' Locating test functions ', 3, None, '___sec22'),
              (' Running tests ', 3, None, '___sec23'),
              (' Installing nose and pytest ', 3, None, '___sec24'),
              (' Test function for the solver ', 2, None, '___sec25'),
              (' Test function for reading positional command-line arguments ',
               2,
               None,
               '___sec26'),
              (' Test function for reading option-value pairs ',
               2,
               None,
               '___sec27'),
              (' Classical class-based unit testing ',
               2,
               'softeng1:basic:unittest',
               'softeng1:basic:unittest'),
              (' Classes for problem and solution method ',
               1,
               'softeng1:prog:se:class',
               'softeng1:prog:se:class'),
              (' The problem class ', 2, None, '___sec30'),
              (' The solver class ', 2, None, '___sec31'),
              (' Combining the objects ', 3, None, '___sec32'),
              (' Improving the problem and solver classes ',
               2,
               'softeng1:prog:se:class2',
               'softeng1:prog:se:class2'),
              (' A generic class for parameters ', 3, None, '___sec34'),
              (' The problem class ', 3, None, '___sec35'),
              (' The solver class ', 3, None, '___sec36'),
              (' Automating scientific experiments ',
               1,
               'softeng1:experiments',
               'softeng1:experiments'),
              (' Available software ', 2, None, '___sec38'),
              (' Required new results ', 2, None, '___sec39'),
              (' Combining plot files ', 2, None, '___sec40'),
              (' Running a program from Python ', 2, None, '___sec41'),
              (' The automating script ', 2, None, '___sec42'),
              (' Making a report ',
               2,
               'softeng1:exper:report',
               'softeng1:exper:report'),
              (' Plain HTML ', 3, None, '___sec44'),
              (' HTML with MathJax ', 3, None, '___sec45'),
              (' LaTeX ', 3, None, '___sec46'),
              (' Sphinx ', 3, None, '___sec47'),
              (' Markdown ', 3, None, '___sec48'),
              (' Wiki formats ', 3, None, '___sec49'),
              (' DocOnce ', 3, None, '___sec50'),
              (' Worked example ', 3, None, '___sec51'),
              (' Publishing a complete project ',
               2,
               'softeng1:exper:github',
               'softeng1:exper:github'),
              (' Exercises ', 1, None, '___sec53'),
              (' Problem 1: Make a tool for differentiating curves ',
               2,
               'softeng1:exer:derivative',
               'softeng1:exer:derivative'),
              (' Problem 2: Make solid software for the Trapezoidal rule ',
               2,
               'softeng1:exer:integral:flat',
               'softeng1:exer:integral:flat'),
              (' Problem 3: Implement classes for the Trapezoidal rule ',
               2,
               'softeng1:exer:integral:flat2',
               'softeng1:exer:integral:flat2'),
              (' Problem 4: Write a doctest ',
               2,
               'softeng1:exer:doctest1',
               'softeng1:exer:doctest1'),
              (' Problem 5: Write a nose test ',
               2,
               'softeng1:exer:nosetest1',
               'softeng1:exer:nosetest1'),
              (' Exercise 6: Make use of a class implementation ',
               2,
               'softeng1:exer:class:dts',
               'softeng1:exer:class:dts'),
              (' Bibliography ', 1, None, '___sec60')]}
end of tocinfo -->

<body>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: {
     equationNumbers: {  autoNumber: "none"  },
     extensions: ["AMSmath.js", "AMSsymbols.js", "autobold.js", "color.js"]
  }
});
</script>
<script type="text/javascript"
 src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<!-- newcommands_keep.tex -->
$$
\newcommand{\tp}{\thinspace .}
$$




    
<!-- Bootstrap navigation bar -->
<div class="navbar navbar-default navbar-fixed-top">
  <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="main_softeng1.html">Scientific software engineering with a simple ODE model as example</a>
  </div>
  <div class="navbar-collapse collapse navbar-responsive-collapse">
    <ul class="nav navbar-nav navbar-right">
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Contents <b class="caret"></b></a>
        <ul class="dropdown-menu">
     <!-- navigation toc: --> <li><a href="#softeng1:basic" style="font-size: 80%;">Basic implementations</a></li>
     <!-- navigation toc: --> <li><a href="#___sec7" style="font-size: 80%;">User interfaces</a></li>
     <!-- navigation toc: --> <li><a href="#___sec15" style="font-size: 80%;">Tests for verifying implementations</a></li>
     <!-- navigation toc: --> <li><a href="#softeng1:prog:se:class" style="font-size: 80%;">Classes for problem and solution method</a></li>
     <!-- navigation toc: --> <li><a href="#softeng1:experiments" style="font-size: 80%;">Automating scientific experiments</a></li>
     <!-- navigation toc: --> <li><a href="#___sec53" style="font-size: 80%;">Exercises</a></li>
     <!-- navigation toc: --> <li><a href="._main_softeng1001.html#___sec60" style="font-size: 80%;">Bibliography</a></li>

        </ul>
      </li>
    </ul>
  </div>
</div>
</div> <!-- end of navigation bar -->

<div class="container">

<p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p> <!-- add vertical space -->

<a name="part0000"></a>
<!-- ------------------- main content ---------------------- -->



<div class="jumbotron">
<center><h1>Scientific software engineering with a simple ODE model as example</h1></center>  <!-- document title -->

<p>
<!-- author(s): Hans Petter Langtangen -->

<center>
<b>Hans Petter Langtangen</b> [1, 2]
</center>


<p>
<!-- institution(s) -->

<center>[1] <b>Center for Biomedical Computing, Simula Research Laboratory</b></center>
<center>[2] <b>Department of Informatics, University of Oslo</b></center>
<p>
<center><h4>Mar 21, 2015</h4></center> <!-- date -->

<h2>Table of contents</h2>

<p>
<a href="#softeng1:basic"> Basic implementations </a><br>
&nbsp; &nbsp; &nbsp; <a href="#softeng1:basic:math"> Mathematical problem and solution technique </a><br>
&nbsp; &nbsp; &nbsp; <a href="#softeng1:basic:impl1"> A first, quick implementation </a><br>
&nbsp; &nbsp; &nbsp; <a href="#softeng1:basic:func"> Isolating the numerical algorithm in a function </a><br>
&nbsp; &nbsp; &nbsp; <a href="#softeng1:basic:module"> Making a module </a><br>
&nbsp; &nbsp; &nbsp; <a href="#softeng1:basic:modprefix"> Prefixing imported functions by the module name </a><br>
&nbsp; &nbsp; &nbsp; <a href="#softeng1:basic:experiment2"> Comparing numerical schemes in one plot </a><br>
<a href="#___sec7"> User interfaces </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec8"> Command-line arguments </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec9"> Positional command-line arguments </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec10"> Option-value pairs on the command line </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec11"> Creating a graphical web user interface </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec12"> Making a compute function </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec13"> Generating the user interface </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec14"> Running the web application </a><br>
<a href="#___sec15"> Tests for verifying implementations </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec16"> Doctests </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec17"> Unit tests and test functions </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec18"> Test frameworks: nose and pytest </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec19"> Test function requirements </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec20"> Comparison of real numbers </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec21"> Special assert functions from nose </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec22"> Locating test functions </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec23"> Running tests </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec24"> Installing nose and pytest </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec25"> Test function for the solver </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec26"> Test function for reading positional command-line arguments </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec27"> Test function for reading option-value pairs </a><br>
&nbsp; &nbsp; &nbsp; <a href="#softeng1:basic:unittest"> Classical class-based unit testing </a><br>
<a href="#softeng1:prog:se:class"> Classes for problem and solution method </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec30"> The problem class </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec31"> The solver class </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec32"> Combining the objects </a><br>
&nbsp; &nbsp; &nbsp; <a href="#softeng1:prog:se:class2"> Improving the problem and solver classes </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec34"> A generic class for parameters </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec35"> The problem class </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec36"> The solver class </a><br>
<a href="#softeng1:experiments"> Automating scientific experiments </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec38"> Available software </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec39"> Required new results </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec40"> Combining plot files </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec41"> Running a program from Python </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec42"> The automating script </a><br>
&nbsp; &nbsp; &nbsp; <a href="#softeng1:exper:report"> Making a report </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec44"> Plain HTML </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec45"> HTML with MathJax </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec46"> LaTeX </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec47"> Sphinx </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec48"> Markdown </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec49"> Wiki formats </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec50"> DocOnce </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec51"> Worked example </a><br>
&nbsp; &nbsp; &nbsp; <a href="#softeng1:exper:github"> Publishing a complete project </a><br>
<a href="#___sec53"> Exercises </a><br>
&nbsp; &nbsp; &nbsp; <a href="#softeng1:exer:derivative"> Problem 1: Make a tool for differentiating curves </a><br>
&nbsp; &nbsp; &nbsp; <a href="#softeng1:exer:integral:flat"> Problem 2: Make solid software for the Trapezoidal rule </a><br>
&nbsp; &nbsp; &nbsp; <a href="#softeng1:exer:integral:flat2"> Problem 3: Implement classes for the Trapezoidal rule </a><br>
&nbsp; &nbsp; &nbsp; <a href="#softeng1:exer:doctest1"> Problem 4: Write a doctest </a><br>
&nbsp; &nbsp; &nbsp; <a href="#softeng1:exer:nosetest1"> Problem 5: Write a nose test </a><br>
&nbsp; &nbsp; &nbsp; <a href="#softeng1:exer:class:dts"> Exercise 6: Make use of a class implementation </a><br>
<a href="._main_softeng1001.html#___sec60"> Bibliography </a><br>
</p>
<p>
<!-- Intro... -->

<p>
Teaching material on scientific computing has traditionally been very
focused on the mathematics and the applications, while details on how
the computer is programmed to solve the problems have received little attention.
Many end up writing as simple programs as possible and are
not aware of much useful computer science technology that would increase
the fun, efficiency, and reliability of the their scientific computing
activities.

<p>
This document demonstrates a series of good practices and tools
from modern computer science, using a very simple mathematical problem
with a very simple implementation such that we minimize the
mathematical details.  Our goal is to increase the technological
quality of computer programming and make it match the more
well-established quality of the mathematics of scientific computing.

<p>
More specifically we address the following scientific topics:

<ul>
 <li> How to structure a code in terms of functions</li>
 <li> How to make a module</li>
 <li> How to read input data flexibly from the command line</li>
 <li> How to create graphical/web user interfaces</li>
 <li> How to write unit tests (test functions or doctests)</li>
 <li> How to refactor code in terms of classes (instead of functions only)</li>
 <li> How to conduct and automate large-scale numerical experiments</li>
 <li> How to write scientific reports in various formats (LaTeX, HTML)</li>
</ul>

The conventions and techniques outlined here will save you a lot of time
when you incrementally extend software over time from simpler to more
complicated problems. In particular, you will benefit from
many good habits:

<ul>
 <li> new code is added in a modular fashion to a library (modules),</li>
 <li> programs are run through convenient user interfaces,</li>
 <li> it takes one quick command to let all your code can undergo heavy testing,</li>
 <li> tedious manual work with running programs is automated,</li>
 <li> your scientific investigations are reproducible,</li>
 <li> scientific reports with top quality typesetting are written both
   for paper and electronic devices.</li>
</ul>



</div> <!-- end jumbotron -->

<h1 id="softeng1:basic">Basic implementations</h1>

<h2 id="softeng1:basic:math">Mathematical problem and solution technique</h2>

<p>
We address the perhaps simplest possible differential equation problem

$$
\begin{align}
u'(t) &= -au(t), \quad t \in (0,T], \tag{1}\\ 
u(0)  &= I,                         \tag{2}
\end{align}
$$

where \( a \), \( I \), and \( T \) are prescribed parameters, and \( u(t) \) is
the unknown function to be estimated. This mathematical model
is relevant for physical phenomena featuring exponential decay
in time, e.g., vertical pressure variation in the atmosphere,
cooling of an object, and radioactive decay.

<p>
The time domain is discretized with points \( 0 = t_0 < t_1 \cdots < t_{N_t}=T \),
here with a constant spacing \( \Delta t \) between the
mesh points: \( \Delta t = t_{n}-t_{n-1} \), \( n=1,\ldots,N_t \). Let
\( u^n \) be the numerical approximation to the exact solution at \( t_n \).
A family of popular numerical methods can be written in the form

$$
\begin{equation}
u^{n+1} = \frac{1 - (1-\theta) a\Delta t}{1 + \theta a\Delta t}u^n,
\tag{3}
\end{equation}
$$

for \( n=0,1,\ldots,N_t-1 \). This numerical scheme corresponds to
the <a href="http://en.wikipedia.org/wiki/Forward_Euler_method" target="_self">Forward Euler</a>
scheme when \( \theta=0 \),
the <a href="http://en.wikipedia.org/wiki/Backward_Euler_method" target="_self">Backward Euler</a>
scheme when \( \theta=1 \),
and the <a href="http://en.wikipedia.org/wiki/Crank-Nicolson" target="_self">Crank-Nicolson</a>
scheme when \( \theta=1/2 \).
The initial condition <a href="#mjx-eqn-2">(2)</a> is key to start
the recursion with a value for \( u^0 \).

<h2 id="softeng1:basic:impl1">A first, quick implementation</h2>

<p>
Solving <a href="#mjx-eqn-3">(3)</a> in a program is very straightforward:
just make a loop over \( n \) and evaluate the formula. The \( u(t_n \))
values for discrete \( n \) can be stored in an array. This makes it easy
to also plot the solution. We may with little work add the exact
solution \( u(t)=Ie^{-at} \) to the plot. A typical program is listed
below.

<p>

<!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>

A <span style="color: #666666">=</span> <span style="color: #666666">1</span>
a <span style="color: #666666">=</span> <span style="color: #666666">2</span>
T <span style="color: #666666">=</span> <span style="color: #666666">4</span>
dt <span style="color: #666666">=</span> <span style="color: #666666">0.2</span>
N <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span style="color: #008000">round</span>(T<span style="color: #666666">/</span>dt))
y <span style="color: #666666">=</span> zeros(N<span style="color: #666666">+1</span>)
t <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, T, N<span style="color: #666666">+1</span>)
theta <span style="color: #666666">=</span> <span style="color: #666666">1</span>
y[<span style="color: #666666">0</span>] <span style="color: #666666">=</span> A
<span style="color: #008000; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">0</span>, N):
    y[n<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)<span style="color: #666666">*</span>y[n]

y_e <span style="color: #666666">=</span> A<span style="color: #666666">*</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t) <span style="color: #666666">-</span> y
error <span style="color: #666666">=</span> y_e <span style="color: #666666">-</span> y
E <span style="color: #666666">=</span> sqrt(dt<span style="color: #666666">*</span><span style="color: #008000">sum</span>(error<span style="color: #666666">**2</span>))
<span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Norm of the error: </span><span style="color: #BB6688; font-weight: bold">%.3E</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> E
plot(t, y, <span style="color: #BA2121">&#39;r--o&#39;</span>)
t_e <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, T, <span style="color: #666666">1001</span>)
y_e <span style="color: #666666">=</span> A<span style="color: #666666">*</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t_e)
plot(t_e, y_e, <span style="color: #BA2121">&#39;b-&#39;</span>)
legend([<span style="color: #BA2121">&#39;numerical, theta=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> theta, <span style="color: #BA2121">&#39;exact&#39;</span>])
xlabel(<span style="color: #BA2121">&#39;t&#39;</span>)
ylabel(<span style="color: #BA2121">&#39;y&#39;</span>)
show()
</pre></div>
<p>
This program is very easy to read, and as long it is correct, many will
claim that it has sufficient quality. Nevertheless, this program suffers
from serious bad habits that might be crucial for writing correct
programs for more complicated mathematical problems. First we list
two really serious issues:

<ol>
<li> The notation in the program does not correspond exactly to
   the notation in the mathematical problem: the solution is called
   <code>y</code> and corresponds to \( u \) in the mathematical description,
   the variable <code>A</code> corresponds to the mathematical parameter \( I \),
   <code>N</code> in the program is called \( N_t \) in the mathematics.</li>
<li> There are no comments in the program.</li>
</ol>

Fixing notation and comments results in

<p>

<!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>

I <span style="color: #666666">=</span> <span style="color: #666666">1</span>
a <span style="color: #666666">=</span> <span style="color: #666666">2</span>
T <span style="color: #666666">=</span> <span style="color: #666666">4</span>
dt <span style="color: #666666">=</span> <span style="color: #666666">0.2</span>
Nt <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span style="color: #008000">round</span>(T<span style="color: #666666">/</span>dt))     <span style="color: #408080; font-style: italic"># no of time intervals</span>
u <span style="color: #666666">=</span> zeros(Nt<span style="color: #666666">+1</span>)           <span style="color: #408080; font-style: italic"># array of u[n] values</span>
t <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, T, Nt<span style="color: #666666">+1</span>)  <span style="color: #408080; font-style: italic"># time mesh</span>
theta <span style="color: #666666">=</span> <span style="color: #666666">1</span>                 <span style="color: #408080; font-style: italic"># Backward Euler method</span>

u[<span style="color: #666666">0</span>] <span style="color: #666666">=</span> I                  <span style="color: #408080; font-style: italic"># assign initial condition</span>
<span style="color: #008000; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">0</span>, Nt):    <span style="color: #408080; font-style: italic"># n=0,1,...,Nt-1</span>
    u[n<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)<span style="color: #666666">*</span>u[n]

<span style="color: #408080; font-style: italic"># Compute norm of the error</span>
u_e <span style="color: #666666">=</span> I<span style="color: #666666">*</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t) <span style="color: #666666">-</span> u     <span style="color: #408080; font-style: italic"># exact u at the mesh points</span>
error <span style="color: #666666">=</span> u_e <span style="color: #666666">-</span> u
E <span style="color: #666666">=</span> sqrt(dt<span style="color: #666666">*</span><span style="color: #008000">sum</span>(error<span style="color: #666666">**2</span>))
<span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Norm of the error: </span><span style="color: #BB6688; font-weight: bold">%.3E</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> E

<span style="color: #408080; font-style: italic"># Compare numerical (u) and exact solution (u_e) in a plot</span>
plot(t, u, <span style="color: #BA2121">&#39;r--o&#39;</span>)               <span style="color: #408080; font-style: italic"># red dashes w/circles</span>
t_e <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, T, <span style="color: #666666">1001</span>)       <span style="color: #408080; font-style: italic"># very fine mesh for u_e</span>
u_e <span style="color: #666666">=</span> I<span style="color: #666666">*</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t_e)
plot(t_e, u_e, <span style="color: #BA2121">&#39;b-&#39;</span>)             <span style="color: #408080; font-style: italic"># blue line for u_e</span>
legend([<span style="color: #BA2121">&#39;numerical, theta=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> theta, <span style="color: #BA2121">&#39;exact&#39;</span>])
xlabel(<span style="color: #BA2121">&#39;t&#39;</span>)
ylabel(<span style="color: #BA2121">&#39;u&#39;</span>)
show()
</pre></div>
<p>
At first sight, this is a good starting point for playing around
with the example: we can just change parameters and rerun.
Let us embed the program in an IPython notebook such that we
can get the plot up in the notebook, see Figure <a href="#softeng1:ipynb">1</a>.

<p>
<center> <!-- figure -->
<hr class="figure">
<center><p class="caption">Figure 1:  Flat experimental code in a notebook. <div id="softeng1:ipynb"></div> </p></center>
<p><img src="fig-softeng1/ipynb_flat.png" align="bottom" width=700></p>
</center>

<p>
Although such an interactive session is good for initial exploration,
one will soon extend the experiments and start developing the code
further. Say we want to compare \( \theta =0,1,0.5 \) in the same
plot. This extension requires changes all over the code and quickly
lead to errors. To do something serious with
this program we have to break it into smaller pieces and make sure
each piece is well tested, is general, and can be reused in new
contexts without changes.
The next natural step is therefore to isolate the numerical computations and
the visualization in separate functions.

<h2 id="softeng1:basic:func">Isolating the numerical algorithm in a function</h2>

<p>
The solution formula <a href="#mjx-eqn-3">(3)</a> is completely general and
should be available as a Python function with all input data as
function arguments and all output data returned to the calling code:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solver</span>(I, a, T, dt, theta):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Solve u&#39;=-a*u, u(0)=I, for t in (0,T] with steps of dt.&quot;&quot;&quot;</span>
    dt <span style="color: #666666">=</span> <span style="color: #008000">float</span>(dt)               <span style="color: #408080; font-style: italic"># avoid integer division</span>
    Nt <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span style="color: #008000">round</span>(T<span style="color: #666666">/</span>dt))        <span style="color: #408080; font-style: italic"># no of time intervals</span>
    T <span style="color: #666666">=</span> Nt<span style="color: #666666">*</span>dt                    <span style="color: #408080; font-style: italic"># adjust T to fit time step dt</span>
    u <span style="color: #666666">=</span> np<span style="color: #666666">.</span>zeros(Nt<span style="color: #666666">+1</span>)           <span style="color: #408080; font-style: italic"># array of u[n] values</span>
    t <span style="color: #666666">=</span> np<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, T, Nt<span style="color: #666666">+1</span>)  <span style="color: #408080; font-style: italic"># time mesh</span>

    u[<span style="color: #666666">0</span>] <span style="color: #666666">=</span> I                  <span style="color: #408080; font-style: italic"># assign initial condition</span>
    <span style="color: #008000; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">0</span>, Nt):    <span style="color: #408080; font-style: italic"># n=0,1,...,Nt-1</span>
        u[n<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)<span style="color: #666666">*</span>u[n]
    <span style="color: #008000; font-weight: bold">return</span> u, t
</pre></div>
<p>
<div class="alert alert-block alert-success alert-text-normal"><b>Tip: Always use a doc string to document a function!</b>
Python has a convention for documenting the purpose and usage of
a function in a <em>doc string</em>: simply place the documentation
in a one- or multi-line triple-quoted string right after the
function header.
</div>


<p>
<div class="alert alert-block alert-success alert-text-normal"><b>Be careful with unintended integer division!</b>
Note that we in the <code>solver</code> function explicitly covert <code>dt</code> to a
<code>float</code> object. If not, the updating formula for <code>u[n+1]</code> may evaluate
to zero because of integer division when <code>theta</code>, <code>a</code>, and <code>dt</code> are integers!
</div>


<p>
With the aid of the <code>solver</code> function, we can solve any problem
of the type <a href="#mjx-eqn-1">(1)</a>-<a href="#mjx-eqn-2">(2)</a> by a one-line
statement:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">u, t <span style="color: #666666">=</span> solver(I<span style="color: #666666">=1</span>, a<span style="color: #666666">=2</span>, T<span style="color: #666666">=4</span>, dt<span style="color: #666666">=0.2</span>, theta<span style="color: #666666">=0.5</span>)
</pre></div>
<p>
One of the most serious flaws in computational work is to have several
slightly different implementations of the same computational algorithms
lying around in various program files. This is very likely to happen,
because busy scientists often want to test a slight variation of a code to see
what happens. A quick copy and edit do the task, but such quick hacks have
a tendency to survive. When a real correction is needed in the implementation,
it is difficult to ensure that the correction is done in all relevant files.
In fact, this is a general problem in programming, which has led to
an important principle.

<p>
<div class="alert alert-block alert-success alert-text-normal"><b>The DRY principle: Don't repeat yourself!</b>
When implementing a particular functionality in a computer program, make sure
this functionality and its variations are implemented in just one piece
of code. That is, if you need to revise the implementation, there should be
<em>one and only one</em> place to edit. It follows that you should never
duplicate code (don't repeat yourself!), and code snippets that are
similar should be factored into one piece (function) and parameterized (by
function arguments).
</div>


<h2 id="softeng1:basic:module">Making a module</h2>

<p>
As soon as you start making Python functions in a program, you should
make sure the program file fulfills the requirement of a module.
This means that you can import and reuse your functions in other
programs too. For example, if our <code>solver</code> function resides in a
module <code>decay</code> in a module file <code>decay.py</code>, we can in any program
do

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">decay</span> <span style="color: #008000; font-weight: bold">import</span> solver
<span style="color: #408080; font-style: italic"># Solve a decay problem</span>
u, t <span style="color: #666666">=</span> solver(I<span style="color: #666666">=1</span>, a<span style="color: #666666">=2</span>, T<span style="color: #666666">=4</span>, dt<span style="color: #666666">=0.2</span>, theta<span style="color: #666666">=0.5</span>)
</pre></div>
<p>
or prefix function names by the module name:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">decay</span>
<span style="color: #408080; font-style: italic"># Solve a decay problem</span>
u, t <span style="color: #666666">=</span> decay<span style="color: #666666">.</span>solver(I<span style="color: #666666">=1</span>, a<span style="color: #666666">=2</span>, T<span style="color: #666666">=4</span>, dt<span style="color: #666666">=0.2</span>, theta<span style="color: #666666">=0.5</span>)
</pre></div>
<p>
The requirements for a program to qualify for a module are simple:

<ol>
<li> The filename without <code>.py</code> must be a valid Python variable name.</li>
<li> The main program must be executed (through statements or
   a function call) in the <em>test block</em>.</li>
</ol>

The <em>test block</em> is normally placed at the end of a module file:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    <span style="color: #408080; font-style: italic"># Statements</span>
</pre></div>
<p>
When the module file is executed as a stand-alone program, the if test
is true and the indented statements are run, but when the module file
is imported, <code>__name__</code> equals the module name and the test block
is not executed.

<p>
To explain the importance of the test block, consider the trivial module
file <code>hello.py</code> with one function and a call to this function as main program:

<p>

<!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">hello</span>(arg<span style="color: #666666">=</span><span style="color: #BA2121">&#39;World!&#39;</span>):
    <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Hello, &#39;</span> <span style="color: #666666">+</span> arg

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    hello()
</pre></div>
<p>
Without the test block,

<p>

<!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">hello</span>(arg<span style="color: #666666">=</span><span style="color: #BA2121">&#39;World!&#39;</span>):
    <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Hello, &#39;</span> <span style="color: #666666">+</span> arg

hello()
</pre></div>
<p>
any attempt to import <code>hello</code> will also execute the call <code>hello()</code> and
hence write `Hello, World!' to the screen.
Such output is not desired when importing a module! However,
with the test block, <code>hello()</code> is not called during import, but
running the file as <code>python hello.py</code> will make the block active
and lead to the desired printing.

<p>
<div class="alert alert-block alert-success alert-text-normal"><b>All coming functions are placed in a module.</b>
The many functions to be explained in the following text are
put in one module file <a href="http://tinyurl.com/nm5587k/decay/decay.py" target="_self"><tt>decay.py</tt></a>.
</div>


<p>
What more than the <code>solver</code> function is needed in our <code>decay</code> module
to do everything we did in the previous, flat program?
We need import statements for <code>numpy</code> and <code>matplotlib</code> as well as
another function for producing the plot. It can also be convenient
to put the exact solution in a Python function.
Our module <code>decay.py</code> then looks like this:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solver</span>(I, a, T, dt, theta):
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_solution</span>(t, I, a):
    <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">experiment_compare_numerical_and_exact</span>():
    I <span style="color: #666666">=</span> <span style="color: #666666">1</span>;  a <span style="color: #666666">=</span> <span style="color: #666666">2</span>;  T <span style="color: #666666">=</span> <span style="color: #666666">4</span>;  dt <span style="color: #666666">=</span> <span style="color: #666666">0.4</span>;  theta <span style="color: #666666">=</span> <span style="color: #666666">1</span>
    u, t <span style="color: #666666">=</span> solver(I, a, T, dt, theta)

    t_e <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, T, <span style="color: #666666">1001</span>)       <span style="color: #408080; font-style: italic"># very fine mesh for u_e</span>
    u_e <span style="color: #666666">=</span> exact_solution(t_e, I, a)

    plot(t,   u,   <span style="color: #BA2121">&#39;r--o&#39;</span>)           <span style="color: #408080; font-style: italic"># dashed red line with circles</span>
    plot(t_e, u_e, <span style="color: #BA2121">&#39;b-&#39;</span>)             <span style="color: #408080; font-style: italic"># blue line for u_e</span>
    legend([<span style="color: #BA2121">&#39;numerical, theta=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> theta, <span style="color: #BA2121">&#39;exact&#39;</span>])
    xlabel(<span style="color: #BA2121">&#39;t&#39;</span>)
    ylabel(<span style="color: #BA2121">&#39;u&#39;</span>)
    plotfile <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;tmp&#39;</span>
    savefig(plotfile <span style="color: #666666">+</span> <span style="color: #BA2121">&#39;.png&#39;</span>);  savefig(plotfile <span style="color: #666666">+</span> <span style="color: #BA2121">&#39;.pdf&#39;</span>)

    error <span style="color: #666666">=</span> exact_solution(t, I, a) <span style="color: #666666">-</span> u
    E <span style="color: #666666">=</span> sqrt(dt<span style="color: #666666">*</span><span style="color: #008000">sum</span>(error<span style="color: #666666">**2</span>))
    <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Error norm:&#39;</span>, E

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    experiment_compare_numerical_and_exact()
</pre></div>
<p>
This module file does exactly the same as the previous, flat program,
but it becomes much easier to extend the code with other plots or
experiments in new functions.  And even more important, the numerical
algorithm is coded and tested once and for all in the <code>solver</code>
function, and any need to solve the mathematical problem is a matter
of one function call.
<!-- (not copying initialization statements and a loop -->
<!-- to a new program for ad hoc editing!). -->

<h2 id="softeng1:basic:modprefix">Prefixing imported functions by the module name</h2>

<p>
Import statements of the form <code>from module import *</code> import
functions and variables in <code>module.py</code> into the current file.
For example, when doing

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
</pre></div>
<p>
we get mathematical functions like <code>sin</code> and <code>exp</code>
as well as MATLAB-style functions like <code>linspace</code> and <code>plot</code>,
which can be called by these well-known names.
Unfortunately, it sometimes becomes confusing to
know where a particular function comes from. Is it from <code>numpy</code>? Or
<code>matplotlib.pyplot</code>?
Or is it our own function?

<p>
An alternative import is

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span>
</pre></div>
<p>
and such imports require functions to be prefixed by the module name, e.g.,

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">t <span style="color: #666666">=</span> numpy<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, T, Nt<span style="color: #666666">+1</span>)
u_e <span style="color: #666666">=</span> I<span style="color: #666666">*</span>numpy<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
matplotlib<span style="color: #666666">.</span>pyplot<span style="color: #666666">.</span>plot(t, u_e)
</pre></div>
<p>
This is normally regarded as a better habit because it is explicitly stated
from which module a function comes from.

<p>
The modules <code>numpy</code> and <code>matplotlib.pyplot</code> are so frequently used,
and their full names quite tedious to write, so two standard abbreviations
have evolved in the Python scientific computing community:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">np</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">plt</span>

t <span style="color: #666666">=</span> np<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, T, Nt<span style="color: #666666">+1</span>)
u_e <span style="color: #666666">=</span> I<span style="color: #666666">*</span>np<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
plt<span style="color: #666666">.</span>plot(t, u_e)
</pre></div>
<p>
A version of the <code>decay_mod</code> module where we use the <code>np</code> and <code>plt</code>
prefixes is found in the file
<a href="http://tinyurl.com/nm5587k/softeng1/decay_mod_prefix.py" target="_self"><tt>decay_mod_prefix.py</tt></a>.

<p>
The downside of prefixing functions by the module name is that
mathematical expressions like \( e^{-at}\sin(2\pi t) \) get
cluttered with module names,
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">numpy<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)<span style="color: #666666">*</span>numpy<span style="color: #666666">.</span>sin(<span style="color: #666666">2</span>(numpy<span style="color: #666666">.</span>pi<span style="color: #666666">*</span>t)
<span style="color: #408080; font-style: italic"># or</span>
np<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)<span style="color: #666666">*</span>np<span style="color: #666666">.</span>sin(<span style="color: #666666">2*</span>np<span style="color: #666666">.</span>pi<span style="color: #666666">*</span>t)
</pre></div>
<p>
Such an expression looks like <code>exp(-a*t)*sin(2*pi*t)</code> in most
other programming languages. Similarly,
<code>np.linspace</code> and <code>plt.plot</code> look less familiar to people who are
used to MATLAB and who have not adopted Python's prefix style.
Whether to do <code>from module import *</code> or <code>import module</code> depends
on personal taste and the problem at hand. In these writings we use
<code>from module import</code> in more basic, shorter programs where similarity with
MATLAB could be an advantage. Prefix of mathematical
functions in formulas is something we often avoid to obtain
a one-to-one correspondence between
mathematical formulas and the Python code.

<p>
Our <code>decay</code> module can be edited to use the module prefix for
<code>matplotlib.pyplot</code> and <code>numpy</code>:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">np</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">plt</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solver</span>(I, a, T, dt, theta):
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_solution</span>(t, I, a):
    <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>np<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">experiment_compare_numerical_and_exact</span>():
    I <span style="color: #666666">=</span> <span style="color: #666666">1</span>;  a <span style="color: #666666">=</span> <span style="color: #666666">2</span>;  T <span style="color: #666666">=</span> <span style="color: #666666">4</span>;  dt <span style="color: #666666">=</span> <span style="color: #666666">0.4</span>;  theta <span style="color: #666666">=</span> <span style="color: #666666">1</span>
    u, t <span style="color: #666666">=</span> solver(I, a, T, dt, theta)

    t_e <span style="color: #666666">=</span> np<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, T, <span style="color: #666666">1001</span>)       <span style="color: #408080; font-style: italic"># very fine mesh for u_e</span>
    u_e <span style="color: #666666">=</span> exact_solution(t_e, I, a)

    plt<span style="color: #666666">.</span>plot(t,   u,   <span style="color: #BA2121">&#39;r--o&#39;</span>)       <span style="color: #408080; font-style: italic"># dashed red line with circles</span>
    plt<span style="color: #666666">.</span>plot(t_e, u_e, <span style="color: #BA2121">&#39;b-&#39;</span>)         <span style="color: #408080; font-style: italic"># blue line for u_e</span>
    plt<span style="color: #666666">.</span>legend([<span style="color: #BA2121">&#39;numerical, theta=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> theta, <span style="color: #BA2121">&#39;exact&#39;</span>])
    plt<span style="color: #666666">.</span>xlabel(<span style="color: #BA2121">&#39;t&#39;</span>)
    plt<span style="color: #666666">.</span>ylabel(<span style="color: #BA2121">&#39;u&#39;</span>)
    plotfile <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;tmp&#39;</span>
    plt<span style="color: #666666">.</span>savefig(plotfile <span style="color: #666666">+</span> <span style="color: #BA2121">&#39;.png&#39;</span>);  plt<span style="color: #666666">.</span>savefig(plotfile <span style="color: #666666">+</span> <span style="color: #BA2121">&#39;.pdf&#39;</span>)

    error <span style="color: #666666">=</span> exact_solution(t, I, a) <span style="color: #666666">-</span> u
    E <span style="color: #666666">=</span> np<span style="color: #666666">.</span>sqrt(dt<span style="color: #666666">*</span>np<span style="color: #666666">.</span>sum(error<span style="color: #666666">**2</span>))
    <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Error norm:&#39;</span>, E

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    experiment_compare_numerical_and_exact()
</pre></div>
<p>
We remark that some would prefer to get rid of the prefix in
mathematical formulas:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">import</span> exp, <span style="color: #008000">sum</span>, sqrt

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_solution</span>(t, I, a):
    <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)

error <span style="color: #666666">=</span> exact_solution(t, I, a) <span style="color: #666666">-</span> u
E <span style="color: #666666">=</span> sqrt(dt<span style="color: #666666">*</span><span style="color: #008000">sum</span>(error<span style="color: #666666">**2</span>))
</pre></div>

<h2 id="softeng1:basic:experiment2">Comparing numerical schemes in one plot</h2>

<p>
Let us specifically demonstrate one extension of the
flat program in Section ref<div id="softeng1:basic:impl1"></div>
that would require substantial editing of the flat code, while
in a structured module, we can simply add a new function without
affecting the existing code and with reusing the implementation
of the numerics.

<p>
Our aim is to make a comparison between the numerical solutions
for various schemes (\( \theta \) values) and the exact solution:

<p>
<center><p><img src="fig-softeng1/compare.png" align="bottom" width=600></p></center>

<p>
<div class="alert alert-block alert-info alert-text-normal"><b>Stop a minute!</b>
Look at the flat program in
the section <a href="#softeng1:basic:impl1">A first, quick implementation</a>,
and try to imagine which edits that are required to solve this new problem.
</div>


<p>
With the <code>solver</code> function at hand, we can simply create a function
with a loop over <code>theta</code> values and add the necessary plot statements:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">experiment_compare_schemes</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Compare theta=0,1,0.5 in the same plot.&quot;&quot;&quot;</span>
    I <span style="color: #666666">=</span> <span style="color: #666666">1</span>;  a <span style="color: #666666">=</span> <span style="color: #666666">2</span>;  T <span style="color: #666666">=</span> <span style="color: #666666">4</span>;  dt <span style="color: #666666">=</span> <span style="color: #666666">0.4</span>
    legends <span style="color: #666666">=</span> []
    <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> [<span style="color: #666666">0</span>, <span style="color: #666666">1</span>, <span style="color: #666666">0.5</span>]:
        u, t <span style="color: #666666">=</span> solver(I, a, T, dt, theta)
        plt<span style="color: #666666">.</span>plot(t, u, <span style="color: #BA2121">&#39;--o&#39;</span>)            <span style="color: #408080; font-style: italic"># dashed lines with circles</span>
        legends<span style="color: #666666">.</span>append(<span style="color: #BA2121">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> theta)
    t_e <span style="color: #666666">=</span> np<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, T, <span style="color: #666666">1001</span>)       <span style="color: #408080; font-style: italic"># very fine mesh for u_e</span>
    u_e <span style="color: #666666">=</span> exact_solution(t_e, I, a)
    plt<span style="color: #666666">.</span>plot(t_e, u_e, <span style="color: #BA2121">&#39;b-&#39;</span>)             <span style="color: #408080; font-style: italic"># blue line for u_e</span>
    legends<span style="color: #666666">.</span>append(<span style="color: #BA2121">&#39;exact&#39;</span>)
    plt<span style="color: #666666">.</span>legend(legends, loc<span style="color: #666666">=</span><span style="color: #BA2121">&#39;upper right&#39;</span>)
    plotfile <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;tmp&#39;</span>
    plt<span style="color: #666666">.</span>savefig(plotfile <span style="color: #666666">+</span> <span style="color: #BA2121">&#39;.png&#39;</span>);  plt<span style="color: #666666">.</span>savefig(plotfile <span style="color: #666666">+</span> <span style="color: #BA2121">&#39;.pdf&#39;</span>)
</pre></div>
<p>
A call to this <code>experiment_compare_schemes</code> function must be placed
in the test block, or you can run the program from IPython instead:

<p>

<!-- code=ipy (!bc ipy) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">In[<span style="color: #666666">1</span>]: <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">decay</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>

In[<span style="color: #666666">2</span>]: experiment_compare_schemes()
</pre></div>

<h1 id="___sec7">User interfaces </h1>

<p>
It is good programming practice to let programs read input from the
user rather than require the user to edit the source code when trying
out new values of input parameters. One reason is that any edit of the
code has a danger of introducing bugs. Another reason is that it is
easier and less manual work to supply data to a program instead of
editing the program code. A third reason is that a program that reads
input can easily be run by another program, and in this way we can
automate a large number of runs in scientific investigations.

<p>
Reading input data can be done in many ways. We have to decide on a
desired <em>user interface</em>, i.e., how we want to operate the program
when providing input, and then use appropriate tools to implement
the user interface. There are four basic types of user interface
of relevance to our programs, listed here with increasing complexity
of the implementation:

<ol>
<li> Questions and answers in the terminal window</li>
<li> Command-line arguments</li>
<li> Reading data from file</li>
<li> Graphical user interfaces (GUIs)</li>
</ol>

Below, we shall address alternative 2 and 4, which are most
appropriate for the present problem and also in general the most
popular types of user interfaces.

<h2 id="___sec8">Command-line arguments </h2>

<p>
The command-line arguments are all the words that appear on the
command line after the program name. Running a program <code>prog</code>
as <code>prog arg1 arg2</code> means that there are two command-line arguments
(separated by white space): <code>arg1</code> and <code>arg2</code>.
Python stores all the command-line arguments in
the list <code>sys.argv</code>, and there are, in principle, two ways of programming with
command-line arguments in Python:

<ul>
 <li> Decide upon a sequence of parameters on the command line and read
   their values directly from the <code>sys.argv[1:]</code> list (<code>sys.argv[0]</code> is
   the just program name).</li>
 <li> Use option-value pairs (<code>--option value</code>) on
   the command line to override default values of input parameters,
   and utilize the <code>argparse.ArgumentParser</code> tool to interact with
   the command line.</li>
</ul>

Suppose we want to run our program <code>decay.py</code> with
specification of \( a \) and \( \Delta t \) on the command line.
With positional command-line arguments we write

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python decay.py 2 0.5
</pre></div>
<p>
knowing that the first argument <code>2</code> is <code>a</code> (\( a \)) and the second `0.5`is
<code>dt</code> (\( \Delta t \)).

<p>
With option-value pairs we can run

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python decay.py --a 2 --dt 0.5
</pre></div>
<p>
Both <code>a</code> and <code>dt</code> are supposed to have default values in the program,
so we need to specify only the parameter that is to be changed from
its default value, e.g.,

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python decay.py --a 2      # a=2, default dt
Terminal&gt; python decay.py --dt 0.7   # dt-0.7, default a
Terminal&gt; python decay.py            # default a and dt
</pre></div>
<p>
As example, we want to read \( I \), \( a \), \( T \), \( \theta \),
and a range of \( \Delta t \) values from the command line.
A plot is then to be made, comparing
the different numerical solutions for different \( \Delta t \) values
against the exact solution.

<h2 id="___sec9">Positional command-line arguments </h2>

<p>
The simplest way of reading the input parameters is to
decide on their sequence on the command line and just index
the <code>sys.argv</code> list accordingly.
Say the sequence is \( I \), \( a \), \( T \), \( \theta \) followed by an
arbitrary number of \( \Delta t \) values. This code extract
these <em>positional</em> command-line arguments:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">sys</span>
I <span style="color: #666666">=</span> <span style="color: #008000">float</span>(sys<span style="color: #666666">.</span>argv[<span style="color: #666666">1</span>])
a <span style="color: #666666">=</span> <span style="color: #008000">float</span>(sys<span style="color: #666666">.</span>argv[<span style="color: #666666">2</span>])
T <span style="color: #666666">=</span> <span style="color: #008000">float</span>(sys<span style="color: #666666">.</span>argv[<span style="color: #666666">3</span>])
theta <span style="color: #666666">=</span> <span style="color: #008000">float</span>(sys<span style="color: #666666">.</span>argv[<span style="color: #666666">4</span>])
dt_values <span style="color: #666666">=</span> [<span style="color: #008000">float</span>(arg) <span style="color: #008000; font-weight: bold">for</span> arg <span style="color: #AA22FF; font-weight: bold">in</span> sys<span style="color: #666666">.</span>argv[<span style="color: #666666">5</span>:]]
</pre></div>
<p>
<div class="alert alert-block alert-success alert-text-normal"><b>Command-line arguments are strings!</b>
Note that all elements in <code>sys.argv</code> are string objects.
If the values will enter mathematical computations, we need
to explicitly convert the strings to numbers.
</div>


<p>
Instead of specifying the \( \theta \) value, we could be a bit more
sophisticated and let the user write the name of the scheme:
<code>BE</code> for Backward Euler, <code>FE</code> for Forward Euler, and <code>CN</code>
for Crank-Nicolson. Then we must map this string to the proper
\( \theta \) value, an operation elegantly done by a dictionary:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">scheme <span style="color: #666666">=</span> sys<span style="color: #666666">.</span>argv[<span style="color: #666666">4</span>]
scheme2theta <span style="color: #666666">=</span> {<span style="color: #BA2121">&#39;BE&#39;</span>: <span style="color: #666666">1</span>, <span style="color: #BA2121">&#39;CN&#39;</span>: <span style="color: #666666">0.5</span>, <span style="color: #BA2121">&#39;FE&#39;</span>: <span style="color: #666666">0</span>}
<span style="color: #008000; font-weight: bold">if</span> scheme <span style="color: #AA22FF; font-weight: bold">in</span> scheme2theta:
    theta <span style="color: #666666">=</span> scheme2theta[scheme]
<span style="color: #008000; font-weight: bold">else</span>:
    <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Invalid scheme name:&#39;</span>, scheme; sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)
</pre></div>

<h2 id="___sec10">Option-value pairs on the command line </h2>

<p>
Now we want specify option-value pairs on the command line,
using <code>--I</code> for <code>I</code> (\( I \)), <code>--a</code> for <code>a</code> (\( a \)), <code>--T</code> for <code>T</code> (\( T \)),
<code>--scheme</code> for the scheme name (<code>BE</code>, <code>FE</code>, <code>CN</code>),
and <code>--dt</code> for the sequence of <code>dt</code> (\( \Delta t \)) values.
Each parameter must have a sensible default value so
that we specify the option on the command line only when the default
value is not suitable. Here is a typical run:

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python decay.py --I 2.5 --dt 0.1 0.2 0.01 --a 0.4
</pre></div>
<p>
Observe the major advantage over positional command-line arguments:
the input is much easier to read and much easier to write.
With positional arguments it is easy to mess up the sequence of
the input parameters and quite challenging to detect errors too,
unless there are just a couple of arguments.

<p>
Python's <code>ArgumentParser</code> tool in the <code>argparse</code> module makes it easy
to create a professional command-line interface to any program. The
documentation of <a href="http://docs.python.org/library/argparse.html" target="_self"><tt>ArgumentParser</tt></a> demonstrates its
versatile applications, so we shall here just list an example
containing basic features. It always pays off to use <code>ArgumentParser</code>
rather than trying to inspect and interpret <code>sys.argv</code> manually!

<p>
The use of <code>ArgumentParser</code> typically involves three steps:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">argparse</span>
parser <span style="color: #666666">=</span> argparse<span style="color: #666666">.</span>ArgumentParser()

<span style="color: #408080; font-style: italic"># Step 1: add arguments</span>
parser<span style="color: #666666">.</span>add_argument(<span style="color: #BA2121">&#39;--option_name&#39;</span>, <span style="color: #666666">...</span>)

<span style="color: #408080; font-style: italic"># Step 2: interpret the command line</span>
args <span style="color: #666666">=</span> parser<span style="color: #666666">.</span>parse_args()

<span style="color: #408080; font-style: italic"># Step 3: extract values</span>
value <span style="color: #666666">=</span> args<span style="color: #666666">.</span>option_name
</pre></div>
<p>
A function for setting up all the options is handy:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">define_command_line_options</span>():
    <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">argparse</span>
    parser <span style="color: #666666">=</span> argparse<span style="color: #666666">.</span>ArgumentParser()
    parser<span style="color: #666666">.</span>add_argument(
        <span style="color: #BA2121">&#39;--I&#39;</span>, <span style="color: #BA2121">&#39;--initial_condition&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
        default<span style="color: #666666">=1.0</span>, help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;initial condition, u(0)&#39;</span>,
        metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;I&#39;</span>)
    parser<span style="color: #666666">.</span>add_argument(
        <span style="color: #BA2121">&#39;--a&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>, default<span style="color: #666666">=1.0</span>,
        help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;coefficient in ODE&#39;</span>, metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;a&#39;</span>)
    parser<span style="color: #666666">.</span>add_argument(
        <span style="color: #BA2121">&#39;--T&#39;</span>, <span style="color: #BA2121">&#39;--stop_time&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
        default<span style="color: #666666">=1.0</span>, help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;end time of simulation&#39;</span>,
        metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;T&#39;</span>)
    parser<span style="color: #666666">.</span>add_argument(
        <span style="color: #BA2121">&#39;--scheme&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">str</span>, default<span style="color: #666666">=</span><span style="color: #BA2121">&#39;CN&#39;</span>,
        help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;FE, BE, or CN&#39;</span>)
    parser<span style="color: #666666">.</span>add_argument(
        <span style="color: #BA2121">&#39;--dt&#39;</span>, <span style="color: #BA2121">&#39;--time_step_values&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
        default<span style="color: #666666">=</span>[<span style="color: #666666">1.0</span>], help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;time step values&#39;</span>,
        metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;dt&#39;</span>, nargs<span style="color: #666666">=</span><span style="color: #BA2121">&#39;+&#39;</span>, dest<span style="color: #666666">=</span><span style="color: #BA2121">&#39;dt_values&#39;</span>)
    <span style="color: #008000; font-weight: bold">return</span> parser
</pre></div>
<p>
Each command-line option is defined through the <code>parser.add_argument</code>
method. Alternative options, like the short <code>--I</code> and the more
explaining version <code>--initial_condition</code> can be defined. Other arguments
are <code>type</code> for the Python object type, a default value, and a help
string, which gets printed if the command-line argument <code>-h</code> or <code>--help</code> is
included. The <code>metavar</code> argument specifies the value associated with
the option when the help string is printed. For example, the option for
\( I \) has this help output:

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python decay_argparse.py -h
  ...
  --I I, --initial_condition I
                        initial condition, u(0)
  ...
</pre></div>
<p>
The structure of this output is

<p>

<!-- code=text typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">  --I metavar, --initial_condition metavar
                        help-string
</pre></div>
<p>
Finally, the <code>--dt</code> option demonstrates how to allow for more than one
value (separated by blanks) through the <code>nargs='+'</code> keyword argument.
After the command line is parsed, we get an object where the values of
the options are stored as attributes. The attribute name is specified
by the <code>dist</code> keyword argument, which for the <code>--dt</code> option is
<code>dt_values</code>. Without the <code>dest</code> argument, the value of an option <code>--opt</code>
is stored as the attribute <code>opt</code>.

<p>
The code below demonstrates how to read the command line and extract
the values for each option:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">read_command_line_argparse</span>():
    parser <span style="color: #666666">=</span> define_command_line_options()
    args <span style="color: #666666">=</span> parser<span style="color: #666666">.</span>parse_args()
    scheme2theta <span style="color: #666666">=</span> {<span style="color: #BA2121">&#39;BE&#39;</span>: <span style="color: #666666">1</span>, <span style="color: #BA2121">&#39;CN&#39;</span>: <span style="color: #666666">0.5</span>, <span style="color: #BA2121">&#39;FE&#39;</span>: <span style="color: #666666">0</span>}
    data <span style="color: #666666">=</span> (args<span style="color: #666666">.</span>I, args<span style="color: #666666">.</span>a, args<span style="color: #666666">.</span>T, scheme2theta[args<span style="color: #666666">.</span>scheme],
            args<span style="color: #666666">.</span>dt_values)
    <span style="color: #008000; font-weight: bold">return</span> data
</pre></div>
<p>
As seen, the values of the command-line options are available as
attributes in <code>args</code>: <code>args.opt</code> holds the value of option <code>--opt</code>, unless
we used the <code>dest</code> argument (as for <code>--dt_values</code>) for specifying the
attribute name. The <code>args.opt</code> attribute has the object type specified
by <code>type</code> (<code>str</code> by default).

<p>
The making of the plot is not dependent on whether we read data from
the command line as positional arguments or option-value pairs:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">experiment_compare_dt</span>(option_value_pairs<span style="color: #666666">=</span><span style="color: #008000">False</span>):
    I, a, T, theta, dt_values <span style="color: #666666">=</span> \ 
       read_command_line_argparse() <span style="color: #008000; font-weight: bold">if</span> option_value_pairs <span style="color: #008000; font-weight: bold">else</span> \ 
       read_command_line_positional()

    legends <span style="color: #666666">=</span> []
    <span style="color: #008000; font-weight: bold">for</span> dt <span style="color: #AA22FF; font-weight: bold">in</span> dt_values:
        u, t <span style="color: #666666">=</span> solver(I, a, T, dt, theta)
        plt<span style="color: #666666">.</span>plot(t, u)
        legends<span style="color: #666666">.</span>append(<span style="color: #BA2121">&#39;dt=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> dt)
    t_e <span style="color: #666666">=</span> np<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, T, <span style="color: #666666">1001</span>)       <span style="color: #408080; font-style: italic"># very fine mesh for u_e</span>
    u_e <span style="color: #666666">=</span> exact_solution(t_e, I, a)
    plt<span style="color: #666666">.</span>plot(t_e, u_e, <span style="color: #BA2121">&#39;--&#39;</span>)            <span style="color: #408080; font-style: italic"># dashed line for u_e</span>
    legends<span style="color: #666666">.</span>append(<span style="color: #BA2121">&#39;exact&#39;</span>)
    plt<span style="color: #666666">.</span>legend(legends, loc<span style="color: #666666">=</span><span style="color: #BA2121">&#39;upper right&#39;</span>)
    plt<span style="color: #666666">.</span>title(<span style="color: #BA2121">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> theta)
    plotfile <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;tmp&#39;</span>
    plt<span style="color: #666666">.</span>savefig(plotfile <span style="color: #666666">+</span> <span style="color: #BA2121">&#39;.png&#39;</span>);  plt<span style="color: #666666">.</span>savefig(plotfile <span style="color: #666666">+</span> <span style="color: #BA2121">&#39;.pdf&#39;</span>)
</pre></div>

<h2 id="___sec11">Creating a graphical web user interface </h2>

<p>
The Python package <a href="https://github.com/hplgit/parampool" target="_self">Parampool</a>
can be used to automatically generate a web-based <em>graphical user interface</em>
(GUI) for our simulation program. Although the programming technique
dramatically simplifies the efforts to create a GUI, the forthcoming
material on equipping our <code>decay_mod</code> module with a GUI is quite technical
and of significantly less importance than knowing how to make
a command-line interface.

<h3 id="___sec12">Making a compute function </h3>

<p>
The first step is to identify a function
that performs the computations and that takes the necessary input
variables as arguments. This is called the <em>compute function</em> in
Parampool terminology. The purpose of this function is to take
values of \( I \), \( a \), \( T \) together with a sequence of \( \Delta t \) values
and a sequence of \( \theta \) and plot the numerical against the
exact solution for each pair of \( (\theta, \Delta t) \).
The plots can be arranged as a table with the columns being scheme type
(\( \theta \) value) and the rows reflecting the discretization parameter
(\( \Delta t \) value). Figure <a href="#softeng1:fig:GUI">2</a> displays of the
graphical web interface may look like after results are computed
(there are \( 3\times 3 \) plots in the GUI, but only \( 2\times 2 \) are
visible in the figure).

<p>
<center> <!-- figure -->
<hr class="figure">
<center><p class="caption">Figure 2:  Automatically generated graphical web interface. <div id="softeng1:fig:GUI"></div> </p></center>
<p><img src="fig-softeng1/web_GUI.png" align="bottom" width=800></p>
</center>

<p>
To tell Parampool what type of input data we have,
we assign default values of the right type to all arguments in the
compute function, here called <code>main_GUI</code>:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main_GUI</span>(I<span style="color: #666666">=1.0</span>, a<span style="color: #666666">=.2</span>, T<span style="color: #666666">=4.0</span>,
             dt_values<span style="color: #666666">=</span>[<span style="color: #666666">1.25</span>, <span style="color: #666666">0.75</span>, <span style="color: #666666">0.5</span>, <span style="color: #666666">0.1</span>],
             theta_values<span style="color: #666666">=</span>[<span style="color: #666666">0</span>, <span style="color: #666666">0.5</span>, <span style="color: #666666">1</span>]):
</pre></div>
<p>
The compute function must return the HTML code we want for displaying
the result in a web page. Here we want to show a
table of plots.
Assume for now that the HTML code for one plot and the value of the
norm of the error can be computed by some other function <code>compute4web</code>.
The <code>main_GUI</code> function can then loop over \( \Delta t \) and \( \theta \)
values and put each plot in an HTML table. Appropriate code goes like

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main_GUI</span>(I<span style="color: #666666">=1.0</span>, a<span style="color: #666666">=.2</span>, T<span style="color: #666666">=4.0</span>,
             dt_values<span style="color: #666666">=</span>[<span style="color: #666666">1.25</span>, <span style="color: #666666">0.75</span>, <span style="color: #666666">0.5</span>, <span style="color: #666666">0.1</span>],
             theta_values<span style="color: #666666">=</span>[<span style="color: #666666">0</span>, <span style="color: #666666">0.5</span>, <span style="color: #666666">1</span>]):
    <span style="color: #408080; font-style: italic"># Build HTML code for web page. Arrange plots in columns</span>
    <span style="color: #408080; font-style: italic"># corresponding to the theta values, with dt down the rows</span>
    theta2name <span style="color: #666666">=</span> {<span style="color: #666666">0</span>: <span style="color: #BA2121">&#39;FE&#39;</span>, <span style="color: #666666">1</span>: <span style="color: #BA2121">&#39;BE&#39;</span>, <span style="color: #666666">0.5</span>: <span style="color: #BA2121">&#39;CN&#39;</span>}
    html_text <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;&lt;table&gt;</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BA2121">&#39;</span>
    <span style="color: #008000; font-weight: bold">for</span> dt <span style="color: #AA22FF; font-weight: bold">in</span> dt_values:
        html_text <span style="color: #666666">+=</span> <span style="color: #BA2121">&#39;&lt;tr&gt;</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BA2121">&#39;</span>
        <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> theta_values:
            E, html <span style="color: #666666">=</span> compute4web(I, a, T, dt, theta)
            html_text <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;&quot;&quot;</span>
<span style="color: #BA2121">&lt;td&gt;</span>
<span style="color: #BA2121">&lt;center&gt;&lt;b&gt;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">, dt=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, error: </span><span style="color: #BB6688; font-weight: bold">%.3E</span><span style="color: #BA2121">&lt;/b&gt;&lt;/center&gt;&lt;br&gt;</span>
<span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"></span>
<span style="color: #BA2121">&lt;/td&gt;</span>
<span style="color: #BA2121">&quot;&quot;&quot;</span> <span style="color: #666666">%</span> (theta2name[theta], dt, E, html)
        html_text <span style="color: #666666">+=</span> <span style="color: #BA2121">&#39;&lt;/tr&gt;</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BA2121">&#39;</span>
    html_text <span style="color: #666666">+=</span> <span style="color: #BA2121">&#39;&lt;/table&gt;</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BA2121">&#39;</span>
    <span style="color: #008000; font-weight: bold">return</span> html_text
</pre></div>
<p>
Making one plot is done in <code>compute4web</code>. The statements should be
straightforward from earlier examples, but there is one new feature:
we use a tool in Parampool to embed the PNG code for a plot file
directly in an HTML image tag. The details are hidden from the
programmer, who can just rely on
relevant HTML code in the string <code>html_text</code>. The function looks like

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">compute4web</span>(I, a, T, dt, theta<span style="color: #666666">=0.5</span>):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Run a case with the solver, compute error measure,</span>
<span style="color: #BA2121; font-style: italic">    and plot the numerical and exact solutions in a PNG</span>
<span style="color: #BA2121; font-style: italic">    plot whose data are embedded in an HTML image tag.</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    u, t <span style="color: #666666">=</span> solver(I, a, T, dt, theta)
    u_e <span style="color: #666666">=</span> exact_solution(t, I, a)
    e <span style="color: #666666">=</span> u_e <span style="color: #666666">-</span> u
    E <span style="color: #666666">=</span> np<span style="color: #666666">.</span>sqrt(dt<span style="color: #666666">*</span>np<span style="color: #666666">.</span>sum(e<span style="color: #666666">**2</span>))

    plt<span style="color: #666666">.</span>figure()
    t_e <span style="color: #666666">=</span> np<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, T, <span style="color: #666666">1001</span>)    <span style="color: #408080; font-style: italic"># fine mesh for u_e</span>
    u_e <span style="color: #666666">=</span> exact_solution(t_e, I, a)
    plt<span style="color: #666666">.</span>plot(t,   u,   <span style="color: #BA2121">&#39;r--o&#39;</span>)       <span style="color: #408080; font-style: italic"># red dashes w/circles</span>
    plt<span style="color: #666666">.</span>plot(t_e, u_e, <span style="color: #BA2121">&#39;b-&#39;</span>)         <span style="color: #408080; font-style: italic"># blue line for exact sol.</span>
    plt<span style="color: #666666">.</span>legend([<span style="color: #BA2121">&#39;numerical&#39;</span>, <span style="color: #BA2121">&#39;exact&#39;</span>])
    plt<span style="color: #666666">.</span>xlabel(<span style="color: #BA2121">&#39;t&#39;</span>)
    plt<span style="color: #666666">.</span>ylabel(<span style="color: #BA2121">&#39;u&#39;</span>)
    plt<span style="color: #666666">.</span>title(<span style="color: #BA2121">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, dt=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> (theta, dt))
    <span style="color: #408080; font-style: italic"># Save plot to HTML img tag with PNG code as embedded data</span>
    <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">parampool.utils</span> <span style="color: #008000; font-weight: bold">import</span> save_png_to_str
    html_text <span style="color: #666666">=</span> save_png_to_str(plt, plotwidth<span style="color: #666666">=400</span>)

    <span style="color: #008000; font-weight: bold">return</span> E, html_text
</pre></div>

<h3 id="___sec13">Generating the user interface </h3>

<p>
The web GUI is automatically generated by
the following code, placed in a file <a href="http://tinyurl.com/nm5587k/softeng1/decay_GUI_generate.py" target="_self"><tt>decay_GUI_generate.py</tt></a>

<p>

<!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">parampool.generator.flask</span> <span style="color: #008000; font-weight: bold">import</span> generate
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">decay</span> <span style="color: #008000; font-weight: bold">import</span> main_GUI
generate(main_GUI,
         filename_controller<span style="color: #666666">=</span><span style="color: #BA2121">&#39;decay_GUI_controller.py&#39;</span>,
         filename_template<span style="color: #666666">=</span><span style="color: #BA2121">&#39;decay_GUI_view.py&#39;</span>,
         filename_model<span style="color: #666666">=</span><span style="color: #BA2121">&#39;decay_GUI_model.py&#39;</span>)
</pre></div>
<p>
Running the <code>decay_GUI_generate.py</code> program results in three new
files whose names are specified in the call to <code>generate</code>:

<ol>
 <li> <code>decay_GUI_model.py</code> defines HTML widgets to be used to set
    input data in the web interface,</li>
 <li> <code>templates/decay_GUI_views.py</code> defines the layout of the web page,</li>
 <li> <code>decay_GUI_controller.py</code> runs the web application.</li>
</ol>

We only need to run the last program, and there is no need to look into
these files.

<h3 id="___sec14">Running the web application </h3>

<p>
The web GUI is started by

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python decay_GUI_controller.py
</pre></div>
<p>
Open a web browser at the location <code>127.0.0.1:5000</code>. Input fields for
<code>I</code>, <code>a</code>, <code>T</code>, <code>dt_values</code>, and <code>theta_values</code> are presented.  Figure
<a href="#softeng1:fig:GUI">2</a> shows a part of the resulting page if we run
with the default values for the input parameters.
With the techniques demonstrated here, one can
easily create a tailored web GUI for a particular type of application
and use it to interactively explore physical and numerical effects.

<h1 id="___sec15">Tests for verifying implementations </h1>

<p>
Any module with functions should have a set of tests that check the
implementations.
There exists
well-established procedures and corresponding tools for automating
the execution of such tests. One can in this way, with a one-line command,
run large test sets and confirm that the software works (as far as the
tests tells). Here we shall illustrate two important
software testing techniques: <em>doctest</em> and <em>unit testing</em>.
The first one is Python specific, while unit testing is the dominating
test technique for computer software today.

<h2 id="___sec16">Doctests </h2>

<p>
A doc string, the first string after the function header, is used to
document the purpose of functions and their arguments
(see the section <a href="#softeng1:basic:func">Isolating the numerical algorithm in a function</a>). Very often it
is instructive to include an example on how to use the function.
Interactive examples in the Python shell are most illustrative as
we can see the output resulting from function calls. For example,
we can in the <code>solver</code> function include an example on calling
this function and printing the computed <code>u</code> and <code>t</code> arrays:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solver</span>(I, a, T, dt, theta):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Solve u&#39;=-a*u, u(0)=I, for t in (0,T] with steps of dt.</span>


<span style="color: #BA2121; font-style: italic">    &gt;&gt;&gt; u, t = solver(I=0.8, a=1.2, T=1.5, dt=0.5, theta=0.5)</span>
<span style="color: #BA2121; font-style: italic">    &gt;&gt;&gt; for t_n, u_n in zip(t, u):</span>
<span style="color: #BA2121; font-style: italic">    ...     print &#39;t=%.1f, u=%.14f&#39; % (t_n, u_n)</span>
<span style="color: #BA2121; font-style: italic">    t=0.0, u=0.80000000000000</span>
<span style="color: #BA2121; font-style: italic">    t=0.5, u=0.43076923076923</span>
<span style="color: #BA2121; font-style: italic">    t=1.0, u=0.23195266272189</span>
<span style="color: #BA2121; font-style: italic">    t=1.5, u=0.12489758761948</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #666666">...</span>
</pre></div>
<p>
When such interactive demonstrations are inserted in doc strings,
Python's <a href="http://docs.python.org/library/doctest.html" target="_self"><tt>doctest</tt></a>
module can be used to automate running all commands
in interactive sessions and compare new output with the output
appearing in the doc string.  All we have to do in the current example
is to run the module file <code>decay.py</code> with

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal<span style="color: #666666">&gt;</span> python <span style="color: #666666">-</span>m doctest decay<span style="color: #666666">.</span>py
</pre></div>
<p>
This command imports the <code>doctest</code> module, which runs all
doctests found in the file.

<p>
<div class="alert alert-block alert-danger alert-text-normal"><b>Doctests prevent command-line arguments!</b>
No additional command-line argument is allowed when running doctests.
If your program relies on command-line input, make sure the tests
can be run with such input.
</div>


<p>
The execution command above will report any problem if a test fails.
For example, changing the last digit <code>8</code> in the output of the doctest
to <code>7</code> triggers a report:

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python -m doctest decay.py
********************************************************
File &quot;decay.py&quot;, line ...
Failed example:
    for t_n, u_n in zip(t, u):
        print &#39;t=%.1f, u=%.14f&#39; % (t_n, u_n)
Expected:
    t=0.0, u=0.80000000000000
    t=0.5, u=0.43076923076923
    t=1.0, u=0.23195266272189
    t=1.5, u=0.12489758761947
Got:
    t=0.0, u=0.80000000000000
    t=0.5, u=0.43076923076923
    t=1.0, u=0.23195266272189
    t=1.5, u=0.12489758761948
</pre></div>
<p>
<div class="alert alert-block alert-danger alert-text-normal"><b>Pay attention to the number of digits in doctest results!</b>
Note that in the output of <code>t</code> and <code>u</code> we write <code>u</code> with 14 digits.
Writing all 16 digits is not a good idea: if the tests are run on
different hardware, round-off errors might be different, and
the <code>doctest</code> module detects that the numbers are not precisely the same
and reports failures. In the present application, where \( 0 < u(t) \leq 0.8 \),
we expect round-off errors to be of size \( 10^{-16} \), so comparing 15
digits would probably be reliable, but we compare 14 to be on the
safe side. On the other hand, comparing a small number of digits may
hide software errors.
</div>


<p>
Doctests are highly encouraged as they do two things: 1) demonstrate
how a function is used and 2) test that the function works.

<p>
<div class="alert alert-block alert-danger alert-text-normal"><b>Caution.</b>
Doctests requires careful coding if they use command-line input or
print results to the terminal window. Command-line input must
be simulated by filling <code>sys.argv</code> correctly, e.g.,
<code>sys.argv = '--I 1.0 --a 5'.split</code>.
The output lines of print statements inside doctests
must be copied exactly as they
appear when running the statements in an interactive Python shell.
</div>


<h2 id="___sec17">Unit tests and test functions </h2>

<p>
The unit testing technique consists of identifying small units
of code, say a function, and write one or more tests for
each unit. One test should, ideally, not depend on the outcome of
other tests. The recommended practice is actually to
design and write the unit tests first and <em>then</em> implement the functions!

<p>
In scientific computing it is not always obvious how to best perform
unit testing. The units is naturally larger than in non-scientific
software. Very often the solution procedure of a mathematical problem
identifies a unit, such as our <code>solver</code> function.

<h3 id="___sec18">Test frameworks: nose and pytest </h3>

<p>
Python offers two very easy-to-use software frameworks for implementing
unit tests: nose and pytest. These work (almost) in the same way,
but my recommendation is to go for pytest.

<h3 id="___sec19">Test function requirements </h3>

<p>
Each test can in these frameworks be realized as a <em>test function</em>
that follows three rules:

<ol>
 <li> The name must start with <code>test_</code>.</li>
 <li> Function arguments are not allowed.</li>
 <li> An <code>AssertionError</code> exception must be raised if the test fails.</li>
</ol>

A specific example might be illustrative before proceeding.
Given a function that doubles the argument,

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">double</span>(n):
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">2*</span>n
</pre></div>
<p>
a corresponding test function may look like this:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_double</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Test that double(n) works for one specific n.&quot;&quot;&quot;</span>
    n <span style="color: #666666">=</span> <span style="color: #666666">4</span>
    expected <span style="color: #666666">=</span> <span style="color: #666666">2*4</span>
    computed <span style="color: #666666">=</span> double(<span style="color: #666666">4</span>)
    <span style="color: #008000; font-weight: bold">if</span> expected <span style="color: #666666">!=</span> computed:
        <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #D2413A; font-weight: bold">AssertionError</span>
</pre></div>
<p>
The last two lines, however, are never written like this in unit tests.
Instead, use Python's <code>assert</code> statement: <code>assert success, msg</code>, where
<code>success</code> is a boolean variable, here <code>False</code> if the test fails, and
<code>msg</code> is <em>an optional</em> message string that is printed when the test fails.
In detail, the test function looks like

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_double</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Test that double(n) works for one specific n.&quot;&quot;&quot;</span>
    n <span style="color: #666666">=</span> <span style="color: #666666">4</span>
    expected <span style="color: #666666">=</span> <span style="color: #666666">2*4</span>
    computed <span style="color: #666666">=</span> double(<span style="color: #666666">4</span>)
    msg <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;expected </span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, computed </span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> (expected, computed)
    success <span style="color: #666666">=</span> expected <span style="color: #666666">==</span> computed
    <span style="color: #008000; font-weight: bold">assert</span> success, msg
</pre></div>

<h3 id="___sec20">Comparison of real numbers </h3>

<p>
In scientific computing we very often have to deal with real numbers and
round-off errors so the <code>==</code> operator must be replaced by a comparison
within a tolerance. Consider testing this function instead,

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">third</span>(x):
    <span style="color: #008000; font-weight: bold">return</span> x<span style="color: #666666">/3.</span>
</pre></div>
<p>
We write a test function where the expected result is computed as
\( \frac{1}{3}x \) rather than \( x/3 \):

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_third</span>():
    x <span style="color: #666666">=</span> <span style="color: #666666">0.1</span>
    expected <span style="color: #666666">=</span> (<span style="color: #666666">1/3.</span>)<span style="color: #666666">*</span>x
    computed <span style="color: #666666">=</span> third(x)
    success <span style="color: #666666">=</span> expected <span style="color: #666666">==</span> computed
    <span style="color: #008000; font-weight: bold">assert</span> success
</pre></div>
<p>
This <code>test_third</code> function executes silently, i.e., no failure, for <code>x = 0.1</code>,
but not if we set <code>x = 0.15</code>. The latter <code>x</code> value gives a round-off error.
The solution to this problem is to compare <code>expected</code> and <code>computed</code>
with a small tolerance:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_third</span>():
    x <span style="color: #666666">=</span> <span style="color: #666666">0.15</span>
    expected <span style="color: #666666">=</span> (<span style="color: #666666">1/3.</span>)<span style="color: #666666">*</span>x
    computed <span style="color: #666666">=</span> third(x)
    tol <span style="color: #666666">=</span> <span style="color: #666666">1E-15</span>
    success <span style="color: #666666">=</span> <span style="color: #008000">abs</span>(expected <span style="color: #666666">-</span> computed) <span style="color: #666666">&lt;</span> tol
    <span style="color: #008000; font-weight: bold">assert</span> success
</pre></div>

<h3 id="___sec21">Special assert functions from nose </h3>

<p>
The nose test framework contains more tailored
<em>assert functions</em> that can be called instead of using the <code>assert</code>
statement. For example, comparing two objects within
a tolerance, as in the present
case, can be done by <code>assert_almost_equal</code>:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">nose.tools</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">nt</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_third</span>():
    x <span style="color: #666666">=</span> <span style="color: #666666">0.15</span>
    expected <span style="color: #666666">=</span> (<span style="color: #666666">1/3.</span>)<span style="color: #666666">*</span>x
    computed <span style="color: #666666">=</span> third(x)
    nt<span style="color: #666666">.</span>assert_almost_equal(
        expected, computed, delta<span style="color: #666666">=1E-15</span>,
        msg<span style="color: #666666">=</span><span style="color: #BA2121">&#39;diff=</span><span style="color: #BB6688; font-weight: bold">%.17E</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> (expected <span style="color: #666666">-</span> computed))
</pre></div>

<h3 id="___sec22">Locating test functions </h3>

<p>
Test functions can reside in a module together with the functions they
are supposed to verify, or the test functions can be collected in
separate files having names starting with <code>test</code>. Actually,
nose and pytest can automatically recursively run all test functions
in all <code>test*.py</code>
files in the current and all subdirectories!

<p>
The <a href="http://tinyurl.com/nm5587k/softeng1/decay.py" target="_self"><tt>decay.py</tt></a> module file features
test functions in the module, but we could equally well have made
a subdirectory <code>tests</code> and put the test functions in
(say) <code>tests/test_decay.py</code>.

<h3 id="___sec23">Running tests </h3>

<p>
To run all test functions in the file <code>decay.py</code> do

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; nosetests -s -v decay.py
Terminal&gt; py.test -s -v decay.py
</pre></div>
<p>
The <code>-s</code> option ensures that output from the test functions is printed
in the terminal window, and <code>-v</code> prints the outcome of each individual
test function.

<p>
Alternatively, if the test functions are in some <code>test*.py</code> files,
we can just write <code>py.test -s -v</code>
to <em>recursively</em> run <em>all</em> test functions in the current
directory tree. The corresponding <code>nosetests -s -v</code> command
does the same, but requires subdirectory names to start
with <code>test</code> or end with <code>_test</code> or <code>_tests</code> (which is a good habit anyway).
An example of a <code>tests</code> directory with a <code>test*.py</code>
file is found in <a href="http://tinyurl.com/nm5587k/softeng1/tests" target="_self">src/softeng1/tests</a>.

<h3 id="___sec24">Installing nose and pytest </h3>

<p>
With <code>pip</code> available, it is trivial to install nose and/or pytest:
<code>sudo pip install nose</code> and <code>sudo pip install pytest</code>.

<h2 id="___sec25">Test function for the solver </h2>

<p>
Finding good test problems for verifying the implementation of numerical
methods is a topic on its own. The challenge is that we very seldom know
what the numerical errors are. For the present model problem
<a href="#mjx-eqn-1">(1)</a>-<a href="#mjx-eqn-2">(2)</a> solved by
<a href="#mjx-eqn-3">(3)</a> one can, fortunately, derive a formula for
the numerical approximation:

$$ u^n = I\left(
\frac{1 - (1-\theta) a\Delta t}{1 + \theta a \Delta t}
\right)^n\tp$$

Then we know that the implementation should
produce numbers that agree with this formula to machine precision.
The formula for \( u^n \) is known as an <em>exact discrete solution</em> of the
problem:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_discrete_solution</span>(n, I, a, theta, dt):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return exact discrete solution of the numerical schemes.&quot;&quot;&quot;</span>
    dt <span style="color: #666666">=</span> <span style="color: #008000">float</span>(dt)  <span style="color: #408080; font-style: italic"># avoid integer division</span>
    A <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)
    <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>A<span style="color: #666666">**</span>n
</pre></div>
<p>
A test function can evaluate this solution on a time mesh
and check that the <code>u</code> values produced by the <code>solver</code> function
do not deviate with more than a small tolerance:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_exact_discrete_solution</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Check that solver reproduces the exact discr. sol.&quot;&quot;&quot;</span>
    theta <span style="color: #666666">=</span> <span style="color: #666666">0.8</span>; a <span style="color: #666666">=</span> <span style="color: #666666">2</span>; I <span style="color: #666666">=</span> <span style="color: #666666">0.1</span>; dt <span style="color: #666666">=</span> <span style="color: #666666">0.8</span>
    Nt <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span style="color: #666666">8/</span>dt)  <span style="color: #408080; font-style: italic"># no of steps</span>
    u, t <span style="color: #666666">=</span> solver(I<span style="color: #666666">=</span>I, a<span style="color: #666666">=</span>a, T<span style="color: #666666">=</span>Nt<span style="color: #666666">*</span>dt, dt<span style="color: #666666">=</span>dt, theta<span style="color: #666666">=</span>theta)
    <span style="color: #408080; font-style: italic"># Evaluate exact discrete solution on the mesh</span>
    u_de <span style="color: #666666">=</span> np<span style="color: #666666">.</span>array([exact_discrete_solution(n, I, a, theta, dt)
                     <span style="color: #008000; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(Nt<span style="color: #666666">+1</span>)])
    diff <span style="color: #666666">=</span> np<span style="color: #666666">.</span>abs(u_de <span style="color: #666666">-</span> u)<span style="color: #666666">.</span>max()  <span style="color: #408080; font-style: italic"># largest deviation</span>
    tol <span style="color: #666666">=</span> <span style="color: #666666">1E-14</span>
    success <span style="color: #666666">=</span> diff <span style="color: #666666">&lt;</span> tol
    <span style="color: #008000; font-weight: bold">assert</span> success
</pre></div>
<p>
An important topic to address in test functions is potentially
problematic input to functions. For example, if \( a \), \( \Delta t \), and
\( \theta \) are integers, one may face problems with unintended integer
division in the numerical solution algorithm for the present mathematical
problem. We should therefore add a test to make sure our <code>solver</code>
function does not fall into this potential trap:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_potential_integer_division</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Choose variables that can trigger integer division.&quot;&quot;&quot;</span>
    theta <span style="color: #666666">=</span> <span style="color: #666666">1</span>; a <span style="color: #666666">=</span> <span style="color: #666666">1</span>; I <span style="color: #666666">=</span> <span style="color: #666666">1</span>; dt <span style="color: #666666">=</span> <span style="color: #666666">2</span>
    Nt <span style="color: #666666">=</span> <span style="color: #666666">4</span>
    u, t <span style="color: #666666">=</span> solver(I<span style="color: #666666">=</span>I, a<span style="color: #666666">=</span>a, T<span style="color: #666666">=</span>Nt<span style="color: #666666">*</span>dt, dt<span style="color: #666666">=</span>dt, theta<span style="color: #666666">=</span>theta)
    u_de <span style="color: #666666">=</span> np<span style="color: #666666">.</span>array([exact_discrete_solution(n, I, a, theta, dt)
                     <span style="color: #008000; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(Nt<span style="color: #666666">+1</span>)])
    diff <span style="color: #666666">=</span> np<span style="color: #666666">.</span>abs(u_de <span style="color: #666666">-</span> u)<span style="color: #666666">.</span>max()
    <span style="color: #008000; font-weight: bold">assert</span> diff <span style="color: #666666">&lt;</span> <span style="color: #666666">1E-14</span>
</pre></div>

<h2 id="___sec26">Test function for reading positional command-line arguments </h2>

<p>
The function <code>read_command_line_positional</code> extracts numbers from the
command line. To test it, decide on a set of numbers, fill <code>sys.argv</code>
appropriately, and check that we get the expected numbers:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_read_command_line_positional</span>():
    <span style="color: #408080; font-style: italic"># Decide on a data set of input parameters</span>
    I <span style="color: #666666">=</span> <span style="color: #666666">1.6</span>;  a <span style="color: #666666">=</span> <span style="color: #666666">1.8</span>;  T <span style="color: #666666">=</span> <span style="color: #666666">2.2</span>;  theta <span style="color: #666666">=</span> <span style="color: #666666">0.5</span>
    dt_values <span style="color: #666666">=</span> [<span style="color: #666666">0.1</span>, <span style="color: #666666">0.2</span>, <span style="color: #666666">0.05</span>]
    <span style="color: #408080; font-style: italic"># Expected return from read_command_line_positional</span>
    expected <span style="color: #666666">=</span> [I, a, T, theta, dt_values]
    <span style="color: #408080; font-style: italic"># Construct corresponding sys.argv array</span>
    sys<span style="color: #666666">.</span>argv <span style="color: #666666">=</span> [sys<span style="color: #666666">.</span>argv[<span style="color: #666666">0</span>], <span style="color: #008000">str</span>(I), <span style="color: #008000">str</span>(a), <span style="color: #008000">str</span>(T), <span style="color: #BA2121">&#39;CN&#39;</span>] <span style="color: #666666">+</span> \ 
               [<span style="color: #008000">str</span>(dt) <span style="color: #008000; font-weight: bold">for</span> dt <span style="color: #AA22FF; font-weight: bold">in</span> dt_values]
    computed <span style="color: #666666">=</span> read_command_line_positional()
    <span style="color: #008000; font-weight: bold">for</span> expected_arg, computed_arg <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">zip</span>(expected, computed):
        <span style="color: #008000; font-weight: bold">assert</span> expected_arg <span style="color: #666666">==</span> computed_arg
</pre></div>
<p>
Note that <code>sys.argv[0]</code> is always the program name and that we have to
copy that string from the original <code>sys.argv</code> array to the new one we
construct in the test function. (Actually, the test function destroys
the original <code>sys.argv</code> that Python fetched from the command line.)

<p>
Any numerical code writer should always be skeptical to the use of the exact
equality operator <code>==</code> in test functions, since round-off errors often
come into play. Here, however, we set some real values, convert them
to strings and convert back again to real numbers (of the same precision).
This string-number conversion does not involve approximation so we
can safely use <code>==</code> in tests. Note also that the last element in
<code>expected</code> and <code>computed</code> is the list <code>dt_values</code>, and <code>==</code> works
for comparing two lists too.

<h2 id="___sec27">Test function for reading option-value pairs </h2>

<p>
Testing the function <code>read_command_line_argparse</code> follows the
set up for the similar function for positional command-line arguments.
However, the construction of the command line is a bit more complicated.
We find it convenient to construct the line as a string and then
split the line into words to get the desired list <code>sys.argv</code>:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_read_command_line_argparse</span>():
    I <span style="color: #666666">=</span> <span style="color: #666666">1.6</span>;  a <span style="color: #666666">=</span> <span style="color: #666666">1.8</span>;  T <span style="color: #666666">=</span> <span style="color: #666666">2.2</span>;  theta <span style="color: #666666">=</span> <span style="color: #666666">0.5</span>
    dt_values <span style="color: #666666">=</span> [<span style="color: #666666">0.1</span>, <span style="color: #666666">0.2</span>, <span style="color: #666666">0.05</span>]
    <span style="color: #408080; font-style: italic"># Expected return from read_command_line_positional</span>
    expected <span style="color: #666666">=</span> [I, a, T, theta, dt_values]
    <span style="color: #408080; font-style: italic"># Construct corresponding sys.argv array</span>
    cml <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"> --a </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"> --I </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"> --T </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"> --scheme CN --dt &#39;</span> <span style="color: #666666">%</span> \ 
          (sys<span style="color: #666666">.</span>argv[<span style="color: #666666">0</span>], a, I, T)
    cml <span style="color: #666666">=</span> cml <span style="color: #666666">+</span> <span style="color: #BA2121">&#39; &#39;</span><span style="color: #666666">.</span>join([<span style="color: #008000">str</span>(dt) <span style="color: #008000; font-weight: bold">for</span> dt <span style="color: #AA22FF; font-weight: bold">in</span> dt_values])
    sys<span style="color: #666666">.</span>argv <span style="color: #666666">=</span> cml<span style="color: #666666">.</span>split()
    computed <span style="color: #666666">=</span> read_command_line_argparse()
    <span style="color: #008000; font-weight: bold">for</span> expected_arg, computed_arg <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">zip</span>(expected, computed):
        <span style="color: #008000; font-weight: bold">assert</span> expected_arg <span style="color: #666666">==</span> computed_arg
</pre></div>
<p>
<div class="alert alert-block alert-danger alert-text-normal"><b>Let silent test functions speak up during development!</b>
When you develop test functions in a module, it is common to use IPython
to reload the module and call the test function as it gets developed:

<p>

<!-- code=ipy (!bc ipy) typeset with pygments style "default" -->
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">In[<span style="color: #666666">1</span>]: <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">decay</span>

In[<span style="color: #666666">2</span>]: decay<span style="color: #666666">.</span>test_read_command_line_argparse()

In[<span style="color: #666666">3</span>]: <span style="color: #008000">reload</span>(decay)  <span style="color: #408080; font-style: italic"># force new import</span>

In[<span style="color: #666666">2</span>]: decay<span style="color: #666666">.</span>test_read_command_line_argparse()  <span style="color: #408080; font-style: italic"># test again</span>
</pre></div>
<p>
However, a working test function is completely silent! Many
find it psychologically annoying to convince themselves that a
completely silent function is doing the right things. It can therefore,
during development of a test function, be convenient to insert
print statements in the function to monitor that the function body
is indeed executed... For example, one can print the expected and
computed values in the terminal window.
</div>


<h2 id="softeng1:basic:unittest">Classical class-based unit testing</h2>

<p>
The test functions written for the nose and pytest frameworks are
very straightforward and to the point, with no framework-required boilerplate
code. We just write the statements we need to make the computations and
comparisons and then make the require <code>assert</code>.

<p>
The classical way implementing unit tests derives from the JUnit
tool in Java and leads to much more comprehensive implementations with
much more boilerplate code.
Python comes with a built-in module <code>unittest</code> for doing this type of
unit tests. Although I strongly recommend to use nose or pytest over
<code>unittest</code>, class-based unit testing in the style of <code>unittest</code>
has a very strong position in computer science and is so widespread
that even computational scientists should have an idea how such
unit test code is written. A short demo of <code>unittest</code> is therefore
included next.

<p>
Suppose we have a function <code>double(x)</code> in a module file <code>mymod.py</code>:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">double</span>(x):
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">2*</span>x
</pre></div>
<p>
Unit testing with the aid of the <code>unittest</code> module
consists of writing a file <code>test_mymod.py</code> for testing the functions
in <code>mymod.py</code>. The individual tests must be methods with names
starting with <code>test_</code> in a class derived from class <code>TestCase</code> in
<code>unittest</code>. With one test method for the function <code>double</code>, the
<code>test_mymod.py</code> file becomes

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">unittest</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">mymod</span>

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">TestMyCode</span>(unittest<span style="color: #666666">.</span>TestCase):
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_double</span>(<span style="color: #008000">self</span>):
        x <span style="color: #666666">=</span> <span style="color: #666666">4</span>
        expected <span style="color: #666666">=</span> <span style="color: #666666">2*</span>x
        computed <span style="color: #666666">=</span> mymod<span style="color: #666666">.</span>double(x)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>assertEqual(expected, computed)

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    unittest<span style="color: #666666">.</span>main()
</pre></div>
<p>
The test is run by executing the test file <code>test_mymod.py</code> as a standard
Python program. There is no support in <code>unittest</code> for automatically
locating and running all tests in all test files in a directory tree.

<p>
We could use the basic <code>assert</code> statement as we did with nose and pytest
functions, but those who write code based on <code>unittest</code> almost
exclusively use the wide range of built-in assert functions such
as <code>assertEqual</code>, <code>assertNotEqual</code>, <code>assertAlmostEqual</code>, to mention
some of them.

<p>
Translation of <code>test_exact_discrete_solution</code>,
<code>test_potential_integer_division</code>, and the other test functions in <code>decay.py</code>
to <code>unittest</code> means making a new file <code>test_decay.py</code> file with a
test class <code>TestDecay</code> where the stand-alone functions for
nose/pytest now become methods in this class.

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">unittest</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">decay</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">np</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_discrete_solution</span>(n, I, a, theta, dt):
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">TestDecay</span>(unittest<span style="color: #666666">.</span>TestCase):

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_exact_discrete_solution</span>(<span style="color: #008000">self</span>):
        theta <span style="color: #666666">=</span> <span style="color: #666666">0.8</span>; a <span style="color: #666666">=</span> <span style="color: #666666">2</span>; I <span style="color: #666666">=</span> <span style="color: #666666">0.1</span>; dt <span style="color: #666666">=</span> <span style="color: #666666">0.8</span>
        Nt <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span style="color: #666666">8/</span>dt)  <span style="color: #408080; font-style: italic"># no of steps</span>
        u, t <span style="color: #666666">=</span> decay<span style="color: #666666">.</span>solver(I<span style="color: #666666">=</span>I, a<span style="color: #666666">=</span>a, T<span style="color: #666666">=</span>Nt<span style="color: #666666">*</span>dt, dt<span style="color: #666666">=</span>dt, theta<span style="color: #666666">=</span>theta)
        <span style="color: #408080; font-style: italic"># Evaluate exact discrete solution on the mesh</span>
        u_de <span style="color: #666666">=</span> np<span style="color: #666666">.</span>array([exact_discrete_solution(n, I, a, theta, dt)
                         <span style="color: #008000; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(Nt<span style="color: #666666">+1</span>)])
        diff <span style="color: #666666">=</span> np<span style="color: #666666">.</span>abs(u_de <span style="color: #666666">-</span> u)<span style="color: #666666">.</span>max()  <span style="color: #408080; font-style: italic"># largest deviation</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>assertAlmostEqual(diff, <span style="color: #666666">0</span>, delta<span style="color: #666666">=1E-14</span>)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_potential_integer_division</span>(<span style="color: #008000">self</span>):
        <span style="color: #666666">...</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>assertAlmostEqual(diff, <span style="color: #666666">0</span>, delta<span style="color: #666666">=1E-14</span>)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_read_command_line_positional</span>(<span style="color: #008000">self</span>):
        <span style="color: #666666">...</span>
        <span style="color: #008000; font-weight: bold">for</span> expected_arg, computed_arg <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">zip</span>(expected, computed):
            <span style="color: #008000">self</span><span style="color: #666666">.</span>assertEqual(expected_arg, computed_arg)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_read_command_line_argparse</span>(<span style="color: #008000">self</span>):
        <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    unittest<span style="color: #666666">.</span>main()
</pre></div>

<h1 id="softeng1:prog:se:class">Classes for problem and solution method</h1>

<p>
The \( \theta \)-rule was compactly and conveniently implemented in
a function <code>solver</code> in the section <a href="#softeng1:basic:math">Mathematical problem and solution technique</a>.
In more complicated problems it might
be beneficial to use classes and introduce a class <code>Problem</code> to
hold the definition of the physical problem, and a class <code>Solver</code>
to hold the data and methods needed to numerically solve the problem.
This idea will now be illustrated, resulting in code that represents
an alternative to the <code>solver</code> and <code>experiment_*</code> functions found
in the <code>decay</code> module.

<p>
Explaining the details of class programming in Python is considered
beyond the scope of this text.  Readers who are unfamiliar with Python
class programming should first consult one of the many electronic
Python tutorials or textbooks to come up to speed with concepts and
syntax of Python classes before reading on. The author has a gentle
introduction to class programming for scientific applications
in <a href="._main_softeng1001.html#Langtangen_2012">[1]</a>, see Chapter 7 and 9 and Appendix E.
Other useful resources are

<ul>
 <li> The Python Tutorial: <a href="http://docs.python.org/2/tutorial/classes.html" target="_self"><tt>http://docs.python.org/2/tutorial/classes.html</tt></a></li>
 <li> Wiki book on Python Programming: <a href="http://en.wikibooks.org/wiki/Python_Programming/Classes" target="_self"><tt>http://en.wikibooks.org/wiki/Python_Programming/Classes</tt></a></li>
 <li> tutorialspoint.com: <a href="http://www.tutorialspoint.com/python/python_classes_objects.htm" target="_self"><tt>http://www.tutorialspoint.com/python/python_classes_objects.htm</tt></a></li>
</ul>

<h2 id="___sec30">The problem class </h2>

<p>
The purpose of the problem class is to store all information about
the mathematical model. This usually means the physical parameters
and formulas
in the problem. Looking at our model problem
<a href="#mjx-eqn-1">(1)</a>-<a href="#mjx-eqn-2">(2)</a>, the physical data cover
\( I \), \( a \), and \( T \). Since we have an analytical solution of
the ODE problem, we may add this solution in terms of a Python
function (or method) to the problem class as well.
A possible problem class is therefore

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">import</span> exp

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Problem</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, I<span style="color: #666666">=1</span>, a<span style="color: #666666">=1</span>, T<span style="color: #666666">=10</span>):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>T, <span style="color: #008000">self</span><span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>a <span style="color: #666666">=</span> I, <span style="color: #008000">float</span>(a), T

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">u_exact</span>(<span style="color: #008000">self</span>, t):
        I, a <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>a
        <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
</pre></div>
<p>
We could in the <code>u_exact</code> method have written
<code>self.I*exp(-self.a*t)</code>, but using local variables <code>I</code> and <code>a</code> allows
the formula <code>I*exp(-a*t)</code> which looks closer to the mathematical
expression \( Ie^{-at} \).  This is not an important issue with the
current compact formula, but is beneficial in more complicated
problems with longer formulas to obtain the closest possible
relationship between code and mathematics. My coding style is to strip
off the <code>self</code> prefix when the code expresses mathematical formulas.

<p>
The class data can be set either as arguments in the constructor or
at any time later, e.g.,

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">problem <span style="color: #666666">=</span> Problem(T<span style="color: #666666">=5</span>)
problem<span style="color: #666666">.</span>T <span style="color: #666666">=</span> <span style="color: #666666">8</span>
problem<span style="color: #666666">.</span>dt <span style="color: #666666">=</span> <span style="color: #666666">1.5</span>
</pre></div>
<p>
(Some programmers prefer <code>set</code> and <code>get</code> functions for setting and getting
data in classes, often implemented via <em>properties</em> in Python, but
I consider that overkill when we just have a few data items in a class.)

<p>
It would be convenient if class <code>Problem</code> could also initialize
the data from the command line. To this end, we add a method for
defining a set of command-line options and a method that sets the
local attributes equal to what was found on the command line.
The default values associated with the command-line options are taken
as the values provided to the constructor. Class <code>Problem</code> now becomes

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Problem</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, I<span style="color: #666666">=1</span>, a<span style="color: #666666">=1</span>, T<span style="color: #666666">=10</span>):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>T, <span style="color: #008000">self</span><span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>a <span style="color: #666666">=</span> I, <span style="color: #008000">float</span>(a), T

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">define_command_line_options</span>(<span style="color: #008000">self</span>, parser<span style="color: #666666">=</span><span style="color: #008000">None</span>):
        <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return updated (parser) or new ArgumentParser object.&quot;&quot;&quot;</span>
        <span style="color: #008000; font-weight: bold">if</span> parser <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000">None</span>:
            <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">argparse</span>
            parser <span style="color: #666666">=</span> argparse<span style="color: #666666">.</span>ArgumentParser()

        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BA2121">&#39;--I&#39;</span>, <span style="color: #BA2121">&#39;--initial_condition&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
            default<span style="color: #666666">=1.0</span>, help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;initial condition, u(0)&#39;</span>,
            metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;I&#39;</span>)
        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BA2121">&#39;--a&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>, default<span style="color: #666666">=1.0</span>,
            help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;coefficient in ODE&#39;</span>, metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;a&#39;</span>)
        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BA2121">&#39;--T&#39;</span>, <span style="color: #BA2121">&#39;--stop_time&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
            default<span style="color: #666666">=1.0</span>, help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;end time of simulation&#39;</span>,
            metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;T&#39;</span>)
        <span style="color: #008000; font-weight: bold">return</span> parser

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">init_from_command_line</span>(<span style="color: #008000">self</span>, args):
        <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Load attributes from ArgumentParser into instance.&quot;&quot;&quot;</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>a, <span style="color: #008000">self</span><span style="color: #666666">.</span>T <span style="color: #666666">=</span> args<span style="color: #666666">.</span>I, args<span style="color: #666666">.</span>a, args<span style="color: #666666">.</span>T

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">u_exact</span>(<span style="color: #008000">self</span>, t):
        <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return the exact solution u(t)=I*exp(-a*t).&quot;&quot;&quot;</span>
        I, a <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>a
        <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
</pre></div>
<p>
Observe that if the user already has an <code>ArgumentParser</code> object it can be
supplied, but if she does not have any, class <code>Problem</code> makes one.
Python's <code>None</code> object is used to indicate that a variable is not
initialized with a proper value.

<h2 id="___sec31">The solver class </h2>

<p>
The solver class stores data related to the numerical solution method
and provides a function <code>solve</code> for solving the problem.
A problem object must be given to the constructor so that the solver
can easily look up physical data. In the present example, the
data related to the numerical solution method consists of \( \Delta t \)
and \( \theta \). We add, as in the problem class, functionality for
reading \( \Delta t \) and \( \theta \) from the command line:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Solver</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, problem, dt<span style="color: #666666">=0.1</span>, theta<span style="color: #666666">=0.5</span>):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>problem <span style="color: #666666">=</span> problem
        <span style="color: #008000">self</span><span style="color: #666666">.</span>dt, <span style="color: #008000">self</span><span style="color: #666666">.</span>theta <span style="color: #666666">=</span> <span style="color: #008000">float</span>(dt), theta

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">define_command_line_options</span>(<span style="color: #008000">self</span>, parser):
        <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return updated (parser) or new ArgumentParser object.&quot;&quot;&quot;</span>
        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BA2121">&#39;--scheme&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">str</span>, default<span style="color: #666666">=</span><span style="color: #BA2121">&#39;CN&#39;</span>,
            help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;FE, BE, or CN&#39;</span>)
        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BA2121">&#39;--dt&#39;</span>, <span style="color: #BA2121">&#39;--time_step_values&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
            default<span style="color: #666666">=</span>[<span style="color: #666666">1.0</span>], help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;time step values&#39;</span>,
            metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;dt&#39;</span>, nargs<span style="color: #666666">=</span><span style="color: #BA2121">&#39;+&#39;</span>, dest<span style="color: #666666">=</span><span style="color: #BA2121">&#39;dt_values&#39;</span>)
        <span style="color: #008000; font-weight: bold">return</span> parser

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">init_from_command_line</span>(<span style="color: #008000">self</span>, args):
        <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Load attributes from ArgumentParser into instance.&quot;&quot;&quot;</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>dt, <span style="color: #008000">self</span><span style="color: #666666">.</span>theta <span style="color: #666666">=</span> args<span style="color: #666666">.</span>dt, args<span style="color: #666666">.</span>theta

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solve</span>(<span style="color: #008000">self</span>):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>u, <span style="color: #008000">self</span><span style="color: #666666">.</span>t <span style="color: #666666">=</span> solver(
            <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>a, <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>T,
            <span style="color: #008000">self</span><span style="color: #666666">.</span>dt, <span style="color: #008000">self</span><span style="color: #666666">.</span>theta)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">error</span>(<span style="color: #008000">self</span>):
        <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return norm of error at the mesh points.&quot;&quot;&quot;</span>
        u_e <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>u_exact(<span style="color: #008000">self</span><span style="color: #666666">.</span>t)
        e <span style="color: #666666">=</span> u_e <span style="color: #666666">-</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>u
        E <span style="color: #666666">=</span> sqrt(<span style="color: #008000">self</span><span style="color: #666666">.</span>dt<span style="color: #666666">*</span><span style="color: #008000">sum</span>(e<span style="color: #666666">**2</span>))
        <span style="color: #008000; font-weight: bold">return</span> E
</pre></div>
<p>
Note that the <code>solve</code> method is just a <em>wrapper</em>
of the previously developed stand-alone <code>solver</code> function.

<h3 id="___sec32">Combining the objects </h3>

<p>
Eventually we need to show how the classes <code>Problem</code> and <code>Solver</code>
play together:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">experiment_classes</span>():
    problem <span style="color: #666666">=</span> Problem()
    solver <span style="color: #666666">=</span> Solver(problem)

    <span style="color: #408080; font-style: italic"># Read input from the command line</span>
    parser <span style="color: #666666">=</span> problem<span style="color: #666666">.</span>define_command_line_options()
    parser <span style="color: #666666">=</span> solver<span style="color: #666666">.</span> define_command_line_options(parser)
    args <span style="color: #666666">=</span> parser<span style="color: #666666">.</span>parse_args()
    problem<span style="color: #666666">.</span>init_from_command_line(args)
    solver<span style="color: #666666">.</span> init_from_command_line(args)

    <span style="color: #408080; font-style: italic"># Solve and plot</span>
    solver<span style="color: #666666">.</span>solve()
    <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">plt</span>
    t_e <span style="color: #666666">=</span> np<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, T, <span style="color: #666666">1001</span>)    <span style="color: #408080; font-style: italic"># very fine mesh for u_e</span>
    u_e <span style="color: #666666">=</span> problem<span style="color: #666666">.</span>u_exact(t_e)

    plt<span style="color: #666666">.</span>plot(t,   u,   <span style="color: #BA2121">&#39;r--o&#39;</span>)       <span style="color: #408080; font-style: italic"># dashed red line with circles</span>
    plt<span style="color: #666666">.</span>plot(t_e, u_e, <span style="color: #BA2121">&#39;b-&#39;</span>)         <span style="color: #408080; font-style: italic"># blue line for u_e</span>
    plt<span style="color: #666666">.</span>legend([<span style="color: #BA2121">&#39;numerical, theta=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> theta, <span style="color: #BA2121">&#39;exact&#39;</span>])
    plt<span style="color: #666666">.</span>xlabel(<span style="color: #BA2121">&#39;t&#39;</span>)
    plt<span style="color: #666666">.</span>ylabel(<span style="color: #BA2121">&#39;u&#39;</span>)
    plotfile <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;tmp&#39;</span>
    plt<span style="color: #666666">.</span>savefig(plotfile <span style="color: #666666">+</span> <span style="color: #BA2121">&#39;.png&#39;</span>);  plt<span style="color: #666666">.</span>savefig(plotfile <span style="color: #666666">+</span> <span style="color: #BA2121">&#39;.pdf&#39;</span>)

    error <span style="color: #666666">=</span> problem<span style="color: #666666">.</span>u_exact(t) <span style="color: #666666">-</span> u
    E <span style="color: #666666">=</span> np<span style="color: #666666">.</span>sqrt(dt<span style="color: #666666">*</span>np<span style="color: #666666">.</span>sum(error<span style="color: #666666">**2</span>))
    <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Error norm:&#39;</span>, E
    plt<span style="color: #666666">.</span>show()


<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    experiment_compare_dt(<span style="color: #008000">True</span>)
    plt<span style="color: #666666">.</span>show()
</pre></div>

<h2 id="softeng1:prog:se:class2">Improving the problem and solver classes</h2>

<p>
The previous <code>Problem</code> and <code>Solver</code> classes containing parameters
soon get much repetitive code when the number of parameters increases.
Much of this code can be parameterized and be made more compact.
For this purpose, we decide to collect all parameters in a dictionary,
<code>self.prm</code>, with two associated dictionaries <code>self.type</code> and
<code>self.help</code> for holding associated object types and help strings.
For the specific ODE example we deal with, such dictionaries are

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #408080; font-style: italic"># Problem data</span>
<span style="color: #008000">self</span><span style="color: #666666">.</span>prm  <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(I<span style="color: #666666">=1</span>, a<span style="color: #666666">=1</span>, T<span style="color: #666666">=10</span>)
<span style="color: #008000">self</span><span style="color: #666666">.</span>type <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(I<span style="color: #666666">=</span><span style="color: #008000">float</span>, a<span style="color: #666666">=</span><span style="color: #008000">float</span>, T<span style="color: #666666">=</span><span style="color: #008000">float</span>)
<span style="color: #008000">self</span><span style="color: #666666">.</span>help <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(I<span style="color: #666666">=</span><span style="color: #BA2121">&#39;initial condition, u(0)&#39;</span>,
                 a<span style="color: #666666">=</span><span style="color: #BA2121">&#39;coefficient in ODE&#39;</span>,
                 T<span style="color: #666666">=</span><span style="color: #BA2121">&#39;end time of simulation&#39;</span>)
<span style="color: #408080; font-style: italic"># Solver data</span>
<span style="color: #008000">self</span><span style="color: #666666">.</span>prm  <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(dt<span style="color: #666666">=0.5</span>, theta<span style="color: #666666">=0.5</span>)
<span style="color: #008000">self</span><span style="color: #666666">.</span>type <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(dt<span style="color: #666666">=</span><span style="color: #008000">float</span>, theta<span style="color: #666666">=</span><span style="color: #008000">float</span>)
<span style="color: #008000">self</span><span style="color: #666666">.</span>help <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(dt<span style="color: #666666">=</span><span style="color: #BA2121">&#39;time step value&#39;</span>,
                 theta<span style="color: #666666">=</span><span style="color: #BA2121">&#39;time discretization parameter&#39;</span>)
</pre></div>
<p>
Provided a problem or solver class defines these three
dictionaries in the constructor, using default or user-supplied values
of the parameters, we can create a super class <code>Parameters</code> with general code
for defining command-line options and reading them as well as
methods for setting and getting a parameter. A <code>Problem</code> or <code>Solver</code> for
a particular mathematical problem can then
inherit most of the needed functionality and code
from the <code>Parameters</code> class.

<h3 id="___sec34">A generic class for parameters </h3>

<p>
A simplified version of the parameter class looks as follows:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Parameters</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">set</span>(<span style="color: #008000">self</span>, <span style="color: #666666">**</span>parameters):
        <span style="color: #008000; font-weight: bold">for</span> name <span style="color: #AA22FF; font-weight: bold">in</span> parameters:
            <span style="color: #008000; font-weight: bold">if</span> name <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>prm:
                <span style="color: #008000">self</span><span style="color: #666666">.</span>prm[name] <span style="color: #666666">=</span> parameters[name]
            <span style="color: #008000; font-weight: bold">else</span>:
                <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #D2413A; font-weight: bold">NameError</span>(<span style="color: #BA2121">&#39;Illegal parameter name </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> name)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">get</span>(<span style="color: #008000">self</span>, name):
        <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return value of parameter with given name.&quot;&quot;&quot;</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>prm[name]

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">define_command_line_options</span>(<span style="color: #008000">self</span>, parser<span style="color: #666666">=</span><span style="color: #008000">None</span>):
        <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Automatic registering of options.&quot;&quot;&quot;</span>
        <span style="color: #008000; font-weight: bold">if</span> parser <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000">None</span>:
            <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">argparse</span>
            parser <span style="color: #666666">=</span> argparse<span style="color: #666666">.</span>ArgumentParser()

        <span style="color: #008000; font-weight: bold">for</span> name <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>prm:
            tp <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>type[name] <span style="color: #008000; font-weight: bold">if</span> name <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>type <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000">str</span>
            help <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>help[name] <span style="color: #008000; font-weight: bold">if</span> name <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>help <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000">None</span>
            parser<span style="color: #666666">.</span>add_argument(
                <span style="color: #BA2121">&#39;--&#39;</span> <span style="color: #666666">+</span> name, default<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>get(name), metavar<span style="color: #666666">=</span>name,
                <span style="color: #008000">type</span><span style="color: #666666">=</span>tp, help<span style="color: #666666">=</span>help)

        <span style="color: #008000; font-weight: bold">return</span> parser

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">init_from_command_line</span>(<span style="color: #008000">self</span>, args):
        <span style="color: #008000; font-weight: bold">for</span> name <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>prm:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>prm[name] <span style="color: #666666">=</span> <span style="color: #008000">getattr</span>(args, name)
</pre></div>
<p>
The file <a href="http://tinyurl.com/nm5587k/softeng1/decay_oo.py" target="_self"><tt>decay_oo.py</tt></a> contains
a slightly more advanced version of class <code>Parameters</code> where we
in the <code>set</code> and <code>get</code> functions test for valid parameter names and
raise exceptions with informative messages if any name is not registered.

<h3 id="___sec35">The problem class </h3>

<p>
A class <code>Problem</code> for the problem \( u'=-au \), \( u(0)=I \), \( t\in (0,T] \), with
parameters input \( a \), \( I \), and \( T \) can now be coded as

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Problem</span>(Parameters):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Physical parameters for the problem u&#39;=-a*u, u(0)=I,</span>
<span style="color: #BA2121; font-style: italic">    with t in [0,T].</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>prm  <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(I<span style="color: #666666">=1</span>, a<span style="color: #666666">=1</span>, T<span style="color: #666666">=10</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>type <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(I<span style="color: #666666">=</span><span style="color: #008000">float</span>, a<span style="color: #666666">=</span><span style="color: #008000">float</span>, T<span style="color: #666666">=</span><span style="color: #008000">float</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>help <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(I<span style="color: #666666">=</span><span style="color: #BA2121">&#39;initial condition, u(0)&#39;</span>,
                         a<span style="color: #666666">=</span><span style="color: #BA2121">&#39;coefficient in ODE&#39;</span>,
                         T<span style="color: #666666">=</span><span style="color: #BA2121">&#39;end time of simulation&#39;</span>)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">u_exact</span>(<span style="color: #008000">self</span>, t):
        I, a <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;I&#39;</span>), <span style="color: #008000">self</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;a&#39;</span>)
        <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>np<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
</pre></div>

<h3 id="___sec36">The solver class </h3>

<p>
Also the solver class is derived from class <code>Parameters</code> and works with
the <code>prms</code>, <code>types</code>, and <code>help</code> dictionaries in the same way as class
<code>Problem</code>. Otherwise, the code is very similar to the previous class <code>Solver</code>:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Solver</span>(Parameters):
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, problem):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>problem <span style="color: #666666">=</span> problem
        <span style="color: #008000">self</span><span style="color: #666666">.</span>prm  <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(dt<span style="color: #666666">=0.5</span>, theta<span style="color: #666666">=0.5</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>type <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(dt<span style="color: #666666">=</span><span style="color: #008000">float</span>, theta<span style="color: #666666">=</span><span style="color: #008000">float</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>help <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(dt<span style="color: #666666">=</span><span style="color: #BA2121">&#39;time step value&#39;</span>,
                         theta<span style="color: #666666">=</span><span style="color: #BA2121">&#39;time discretization parameter&#39;</span>)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solve</span>(<span style="color: #008000">self</span>):
        <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">decay_mod</span> <span style="color: #008000; font-weight: bold">import</span> solver
        <span style="color: #008000">self</span><span style="color: #666666">.</span>u, <span style="color: #008000">self</span><span style="color: #666666">.</span>t <span style="color: #666666">=</span> solver(
            <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;I&#39;</span>),
            <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;a&#39;</span>),
            <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;T&#39;</span>),
            <span style="color: #008000">self</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;dt&#39;</span>),
            <span style="color: #008000">self</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;theta&#39;</span>))

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">error</span>(<span style="color: #008000">self</span>):
        <span style="color: #008000; font-weight: bold">try</span>:
            u_e <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>u_exact(<span style="color: #008000">self</span><span style="color: #666666">.</span>t)
            e <span style="color: #666666">=</span> u_e <span style="color: #666666">-</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>u
            E <span style="color: #666666">=</span> np<span style="color: #666666">.</span>sqrt(<span style="color: #008000">self</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;dt&#39;</span>)<span style="color: #666666">*</span>np<span style="color: #666666">.</span>sum(e<span style="color: #666666">**2</span>))
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #D2413A; font-weight: bold">AttributeError</span>:
            E <span style="color: #666666">=</span> <span style="color: #008000">None</span>
        <span style="color: #008000; font-weight: bold">return</span> E
</pre></div>
<p>
The advantage with the <code>Parameters</code> class is that it scales to problems
with a large number of physical and numerical parameters:
as long as the parameters are defined once via a dictionary,
the compact code in class <code>Parameters</code> can handle any collection of
parameters of any size.

<h1 id="softeng1:experiments">Automating scientific experiments</h1>

<p>
Empirical scientific investigations based on running computer programs
require careful design of the experiments and accurate reporting of results.
Although there is a strong tradition to do such investigations manually,
the extreme requirements to scientific accuracy make a program much
better suited to conduct the experiments. We shall in this section outline
how we can write such programs, often called <em>scripts</em>, for running other
programs and archiving the results.

<p>
<div class="alert alert-block alert-success alert-text-normal"><b>Scientific investigation.</b>
The purpose of the investigations is to explore the quality of numerical
solutions to an ordinary differential equation. More specifically, we
solve the initial-value problem

$$
\begin{equation}
u^\prime(t) = -au(t),\quad u(0)=I,\quad t\in (0,T],
\tag{4}
\end{equation}
$$

by the \( \theta \)-rule:

$$
\begin{equation}
u^{n+1} = \frac{1 - (1-\theta) a\Delta t}{1 + \theta a\Delta t}u^n,
\quad u^0=I\tp
\tag{5}
\end{equation}
$$

This scheme corresponds to well-known methods: \( \theta=0 \) gives the
Forward Euler (FE) scheme, \( \theta=1 \) gives the Backward Euler (BE) scheme,
and \( \theta=\frac{1}{2} \) gives the Crank-Nicolson
(CN) or midpoint/centered scheme.

<p>
For fixed \( I \), \( a \), and \( T \), we run the three schemes for various
values of \( \Delta t \), and present in a report the following results:

<ol>
<li> visual comparison of the numerical and exact solution in a plot for
   each \( \Delta t \) and \( \theta=0,1,\frac{1}{2} \),</li>
<li> a table and a plot of the norm of the numerical error versus \( \Delta t \)
   for \( \theta=0,1,\frac{1}{2} \).</li>
</ol>

The report will also document the mathematical details of the problem under
investigation.
</div>


<h2 id="___sec38">Available software </h2>

<p>
Appropriate software for implementing <a href="#mjx-eqn-5">(5)</a>
is available in a program <a href="http://hplgit.github.io/teamods/writing_reports/doconce_src/model.py" target="_self"><tt>model.py</tt></a>, which is run as

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python model.py --I 1.5 --a 0.25 --T 6 --dt 1.25 0.75 0.5
</pre></div>
<p>
The command-line input corresponds to setting \( I=1.5 \), \( a=0.25 \), \( T=6 \),
and run three values of \( \Delta t \): 1.25, 0.75, ad 0.5.

<p>
The results of running this <code>model.py</code> command are text in the
terminal window and a set of plot files.
The plot files have names <code>M_D.E</code>, where <code>M</code> denotes the method
(<code>FE</code>, <code>BE</code>, <code>CN</code> for \( \theta=0,1,\frac{1}{2} \)), <code>D</code>
the time step length (here <code>1.25</code>, <code>0.75</code>, or <code>0.5</code>), and <code>E</code>
is the plot file extension <code>png</code> or <code>pdf</code>.
The text output looks like

<p>

<!-- code=text typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">0.0   1.25:    5.998E-01
0.0   0.75:    1.926E-01
0.0   0.50:    1.123E-01
0.0   0.10:    1.558E-02
0.5   1.25:    6.231E-02
0.5   0.75:    1.543E-02
0.5   0.50:    7.237E-03
0.5   0.10:    2.469E-04
1.0   1.25:    1.766E-01
1.0   0.75:    8.579E-02
1.0   0.50:    6.884E-02
1.0   0.10:    1.411E-02
</pre></div>
<p>
The first column is the \( \theta \) value, the next the \( \Delta t \) value,
and the final column represents the numerical error \( E \) (the
norm of discrete error function on the mesh).

<h2 id="___sec39">Required new results </h2>

<p>
The results we need for our investigations are slightly different than
what is directly produced by <code>model.py</code>:

<ol>
<li> We need to collect all the plots for one
   numerical method (FE, BE, CN) in a single plot.
   For example, if 4 \( \Delta t \) values are run, the summarizing plot
   for the BE method has \( 2\times 2 \) subplots, with the subplot corresponding
   to the largest \( \Delta t \) is in the upper left corner and the smallest
   is in the bottom right corner.</li>
<li> We need to have a table containing
   \( \Delta t \) values in the first column and the numerical error
   \( E \) for \( \theta0,0.5,1 \)
   in the next three columns. This table should be available as a
   standard CSV file.</li>
<li> We need to plot the numerical error \( E \) versus \( \Delta t \)
   in a log-log plot.</li>
</ol>

Consequently, we need to write a program (script)
that can run <code>model.py</code> as described and
produce the results 1-3 above. This requires combining multiple plot files into
a file and interpreting the output from <code>model.py</code> as data for plotting and
file storage.

<p>
If the script's name is <code>exper1.py</code>, we run it with the desired \( \Delta t \)
values as positional command-line arguments:

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python exper1.py 0.5 0.25 0.1 0.05
</pre></div>
<p>
This run will then generate eight plot files: <code>FE.png</code> and <code>FE.pdf</code> summarizing
the plots with the FE method, <code>BE.png</code> and <code>BE.pdf</code> with
the BE method, <code>CN.png</code> and <code>CN.pdf</code> with the CN method, and <code>error.png</code>
and <code>error.pdf</code> with the log-log plot of the numerical error versus \( \Delta t \).
In addition, the table with numerical errors is written to a
file <code>error.csv</code>.

<p>
<div class="alert alert-block alert-danger alert-text-normal"><b>Reproducible science.</b>
A script that automates running our computer experiments
will ensure
that the experiments can easily be rerun by ourselves or others in
the future, either to check the results or redo the experiments with
other input data. Also, whatever we did to produce the results is
documented in every detail in the script.
Automating scripts are therefore essential to making our
research <em>reproducible</em>, which is a fundamental principle in science.
</div>


<h2 id="___sec40">Combining plot files </h2>

<p>
Image files can be combined to new files using the
<a href="http://www.imagemagick.org/script/montage.php" target="_self"><tt>montage</tt></a>
and
<a href="http://www.imagemagick.org/script/convert.php" target="_self"><tt>convert</tt></a> programs in
the ImageMagick software suite. However, these programs are best suited for
PNG files. For vector plots in PDF format one needs other tools
to preserve the quality: <code>pdftk</code>, <code>pdfnup</code>, and <code>pdfcrop</code>.
Suppose you have four files <code>f1.png</code>, <code>f2.png</code>, <code>f3.png</code>, and <code>f4.png</code>
and want to combine them into a \( 2\times 2 \) table of subplots in a new
file <code>f.png</code>, see
Figure <a href="#softeng1:experiments:fig:BE4a">3</a> for an example.

<p>
<center> <!-- figure -->
<hr class="figure">
<center><p class="caption">Figure 3:  Illustration of the Backward Euler method for four time step values. <div id="softeng1:experiments:fig:BE4a"></div> </p></center>
<p><img src="fig-softeng1/BE4a.png" align="bottom" width=600,></p>
</center>

<p>
The appropriate ImageMagick commands are

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; montage -background white -geometry 100% -tile 2x \ 
          f1.png f2.png f3.png f4.png f.png
Terminal&gt; convert -trim f.png f.png
Terminal&gt; convert f.png -transparent white f.png
</pre></div>
<p>
The first command mounts the four files in one, the next <code>convert</code> command
removes unnecessary surrounding white space, and the final <code>convert</code> command
makes the white background transparent.

<p>
High-quality montage of PDF files <code>f1.pdf</code>,
<code>f2.pdf</code>, <code>f3.pdf</code>, and <code>f4.pdf</code> into <code>f.pdf</code> goes like

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; pdftk f1.pdf f2.pdf f3.pdf f4.pdf output tmp.pdf
Terminal&gt; pdfnup --nup 2x2 --outfile tmp.pdf tmp.pdf
Terminal&gt; pdfcrop tmp.pdf f.pdf
Terminal&gt; rm -f tmp.pdf
</pre></div>

<h2 id="___sec41">Running a program from Python </h2>

<p>
Suppose you want to run some operating system command stored in a string
<code>cmd</code>. For example, <code>cmd</code> could be <code>python model.py --I 1 --dt 0.5 0.2</code>.
The following Python code
executes <code>cmd</code> and loads the text output into a string <code>output</code>:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">subprocess</span> <span style="color: #008000; font-weight: bold">import</span> Popen, PIPE, STDOUT
p <span style="color: #666666">=</span> Popen(cmd, shell<span style="color: #666666">=</span><span style="color: #008000">True</span>, stdout<span style="color: #666666">=</span>PIPE, stderr<span style="color: #666666">=</span>STDOUT)
output, dummy <span style="color: #666666">=</span> p<span style="color: #666666">.</span>communicate()

<span style="color: #408080; font-style: italic"># Check if run was successful</span>
failure <span style="color: #666666">=</span> p<span style="color: #666666">.</span>returncode
<span style="color: #008000; font-weight: bold">if</span> failure:
    <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Command failed:&#39;</span>, cmd; sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)
</pre></div>
<p>
In our case, we need to interpret the contents of <code>output</code> and store
the data in an appropriate data structure.
Since the content is basically a table and will be transformed to
a spread sheet format, we let the columns in the table be lists,
and we collect the columns in a dictionary whose keys are natural
column names: <code>dt</code> and the three values of \( \theta \).
The following code translates <code>output</code> to such a dictionary of lists:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">errors <span style="color: #666666">=</span> {<span style="color: #BA2121">&#39;dt&#39;</span>: dt_values, <span style="color: #666666">1</span>: [], <span style="color: #666666">0</span>: [], <span style="color: #666666">0.5</span>: []}
<span style="color: #008000; font-weight: bold">for</span> line <span style="color: #AA22FF; font-weight: bold">in</span> output<span style="color: #666666">.</span>splitlines():
    words <span style="color: #666666">=</span> line<span style="color: #666666">.</span>split()
    <span style="color: #008000; font-weight: bold">if</span> words[<span style="color: #666666">0</span>] <span style="color: #AA22FF; font-weight: bold">in</span> (<span style="color: #BA2121">&#39;0.0&#39;</span>, <span style="color: #BA2121">&#39;0.5&#39;</span>, <span style="color: #BA2121">&#39;1.0&#39;</span>):  <span style="color: #408080; font-style: italic"># line with E?</span>
        <span style="color: #408080; font-style: italic"># typical line: 0.0   1.25:    7.463E+00</span>
        theta <span style="color: #666666">=</span> <span style="color: #008000">float</span>(words[<span style="color: #666666">0</span>])
        E <span style="color: #666666">=</span> <span style="color: #008000">float</span>(words[<span style="color: #666666">2</span>])
        errors[theta]<span style="color: #666666">.</span>append(E)
</pre></div>

<h2 id="___sec42">The automating script </h2>

<p>
Running <code>model.py</code> for a set of \( \Delta t \) values and producing files as
described above, can be done by the following code:

<p>

<!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">os</span><span style="color: #666666">,</span> <span style="color: #0000FF; font-weight: bold">sys</span><span style="color: #666666">,</span> <span style="color: #0000FF; font-weight: bold">glob</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">plt</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">run_experiments</span>(I<span style="color: #666666">=1</span>, a<span style="color: #666666">=2</span>, T<span style="color: #666666">=5</span>):
    <span style="color: #408080; font-style: italic"># The command line must contain dt values</span>
    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(sys<span style="color: #666666">.</span>argv) <span style="color: #666666">&gt;</span> <span style="color: #666666">1</span>:
        dt_values <span style="color: #666666">=</span> [<span style="color: #008000">float</span>(arg) <span style="color: #008000; font-weight: bold">for</span> arg <span style="color: #AA22FF; font-weight: bold">in</span> sys<span style="color: #666666">.</span>argv[<span style="color: #666666">1</span>:]]
    <span style="color: #008000; font-weight: bold">else</span>:
        <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Usage: </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"> dt1 dt2 dt3 ...&#39;</span> <span style="color: #666666">%</span>  sys<span style="color: #666666">.</span>argv[<span style="color: #666666">0</span>]
        sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)  <span style="color: #408080; font-style: italic"># abort</span>

    <span style="color: #408080; font-style: italic"># Run module file and grab output</span>
    cmd <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;python model.py --I </span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121"> --a </span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121"> --T </span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> (I, a, T)
    dt_values_str <span style="color: #666666">=</span> <span style="color: #BA2121">&#39; &#39;</span><span style="color: #666666">.</span>join([<span style="color: #008000">str</span>(v) <span style="color: #008000; font-weight: bold">for</span> v <span style="color: #AA22FF; font-weight: bold">in</span> dt_values])
    cmd <span style="color: #666666">+=</span> <span style="color: #BA2121">&#39; --dt </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> dt_values_str
    <span style="color: #008000; font-weight: bold">print</span> cmd
    <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">subprocess</span> <span style="color: #008000; font-weight: bold">import</span> Popen, PIPE, STDOUT
    p <span style="color: #666666">=</span> Popen(cmd, shell<span style="color: #666666">=</span><span style="color: #008000">True</span>, stdout<span style="color: #666666">=</span>PIPE, stderr<span style="color: #666666">=</span>STDOUT)
    output, dummy <span style="color: #666666">=</span> p<span style="color: #666666">.</span>communicate()
    failure <span style="color: #666666">=</span> p<span style="color: #666666">.</span>returncode
    <span style="color: #008000; font-weight: bold">if</span> failure:
        <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Command failed:&#39;</span>, cmd; sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)

    errors <span style="color: #666666">=</span> {<span style="color: #BA2121">&#39;dt&#39;</span>: dt_values, <span style="color: #666666">1</span>: [], <span style="color: #666666">0</span>: [], <span style="color: #666666">0.5</span>: []}
    <span style="color: #008000; font-weight: bold">for</span> line <span style="color: #AA22FF; font-weight: bold">in</span> output<span style="color: #666666">.</span>splitlines():
        words <span style="color: #666666">=</span> line<span style="color: #666666">.</span>split()
        <span style="color: #008000; font-weight: bold">if</span> words[<span style="color: #666666">0</span>] <span style="color: #AA22FF; font-weight: bold">in</span> (<span style="color: #BA2121">&#39;0.0&#39;</span>, <span style="color: #BA2121">&#39;0.5&#39;</span>, <span style="color: #BA2121">&#39;1.0&#39;</span>):  <span style="color: #408080; font-style: italic"># line with E?</span>
            <span style="color: #408080; font-style: italic"># typical line: 0.0   1.25:    7.463E+00</span>
            theta <span style="color: #666666">=</span> <span style="color: #008000">float</span>(words[<span style="color: #666666">0</span>])
            E <span style="color: #666666">=</span> <span style="color: #008000">float</span>(words[<span style="color: #666666">2</span>])
            errors[theta]<span style="color: #666666">.</span>append(E)

    <span style="color: #408080; font-style: italic"># Find min/max for the axis</span>
    E_min <span style="color: #666666">=</span> <span style="color: #666666">1E+20</span>; E_max <span style="color: #666666">=</span> <span style="color: #666666">-</span>E_min
    <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #666666">0</span>, <span style="color: #666666">0.5</span>, <span style="color: #666666">1</span>:
        E_min <span style="color: #666666">=</span> <span style="color: #008000">min</span>(E_min, <span style="color: #008000">min</span>(errors[theta]))
        E_max <span style="color: #666666">=</span> <span style="color: #008000">max</span>(E_max, <span style="color: #008000">max</span>(errors[theta]))

    plt<span style="color: #666666">.</span>loglog(errors[<span style="color: #BA2121">&#39;dt&#39;</span>], errors[<span style="color: #666666">0</span>], <span style="color: #BA2121">&#39;ro-&#39;</span>)
    <span style="color: #408080; font-style: italic">#plt.hold(&#39;on&#39;)  # Matlab style...</span>
    plt<span style="color: #666666">.</span>loglog(errors[<span style="color: #BA2121">&#39;dt&#39;</span>], errors[<span style="color: #666666">0.5</span>], <span style="color: #BA2121">&#39;b+-&#39;</span>)
    plt<span style="color: #666666">.</span>loglog(errors[<span style="color: #BA2121">&#39;dt&#39;</span>], errors[<span style="color: #666666">1</span>], <span style="color: #BA2121">&#39;gx-&#39;</span>)
    plt<span style="color: #666666">.</span>legend([<span style="color: #BA2121">&#39;FE&#39;</span>, <span style="color: #BA2121">&#39;CN&#39;</span>, <span style="color: #BA2121">&#39;BE&#39;</span>], loc<span style="color: #666666">=</span><span style="color: #BA2121">&#39;upper left&#39;</span>)
    plt<span style="color: #666666">.</span>xlabel(<span style="color: #BA2121">&#39;log(time step)&#39;</span>)
    plt<span style="color: #666666">.</span>ylabel(<span style="color: #BA2121">&#39;log(error)&#39;</span>)
    plt<span style="color: #666666">.</span>axis([<span style="color: #008000">min</span>(dt_values), <span style="color: #008000">max</span>(dt_values), E_min, E_max])
    plt<span style="color: #666666">.</span>title(<span style="color: #BA2121">&#39;Error vs time step&#39;</span>)
    plt<span style="color: #666666">.</span>savefig(<span style="color: #BA2121">&#39;error.png&#39;</span>)
    plt<span style="color: #666666">.</span>savefig(<span style="color: #BA2121">&#39;error.pdf&#39;</span>)
    <span style="color: #408080; font-style: italic"># Write out a table in CSV format</span>
    f <span style="color: #666666">=</span> <span style="color: #008000">open</span>(<span style="color: #BA2121">&#39;error.csv&#39;</span>, <span style="color: #BA2121">&#39;w&#39;</span>)
    f<span style="color: #666666">.</span>write(<span style="color: #BA2121">r&#39;$\Delta t$,$\theta=0$,$\theta=0.5$,$\theta=1$&#39;</span> <span style="color: #666666">+</span> <span style="color: #BA2121">&#39;</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BA2121">&#39;</span>)
    <span style="color: #008000; font-weight: bold">for</span> _dt, _fe, _cn, _be <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">zip</span>(
        errors[<span style="color: #BA2121">&#39;dt&#39;</span>], errors[<span style="color: #666666">0</span>], errors[<span style="color: #666666">0.5</span>], errors[<span style="color: #666666">1</span>]):
        f<span style="color: #666666">.</span>write(<span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%.2f</span><span style="color: #BA2121">,</span><span style="color: #BB6688; font-weight: bold">%.4f</span><span style="color: #BA2121">,</span><span style="color: #BB6688; font-weight: bold">%.4f</span><span style="color: #BA2121">,</span><span style="color: #BB6688; font-weight: bold">%.4f</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> (_dt, _fe, _cn, _be))
    f<span style="color: #666666">.</span>close()

    <span style="color: #408080; font-style: italic"># Combine images into rows with 2 plots in each row</span>
    image_commands <span style="color: #666666">=</span> []
    <span style="color: #008000; font-weight: bold">for</span> method <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #BA2121">&#39;BE&#39;</span>, <span style="color: #BA2121">&#39;CN&#39;</span>, <span style="color: #BA2121">&#39;FE&#39;</span>:
        pdf_files <span style="color: #666666">=</span> <span style="color: #BA2121">&#39; &#39;</span><span style="color: #666666">.</span>join([<span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">_</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">.pdf&#39;</span> <span style="color: #666666">%</span> (method, dt)
                              <span style="color: #008000; font-weight: bold">for</span> dt <span style="color: #AA22FF; font-weight: bold">in</span> dt_values])
        png_files <span style="color: #666666">=</span> <span style="color: #BA2121">&#39; &#39;</span><span style="color: #666666">.</span>join([<span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">_</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span> (method, dt)
                              <span style="color: #008000; font-weight: bold">for</span> dt <span style="color: #AA22FF; font-weight: bold">in</span> dt_values])
        image_commands<span style="color: #666666">.</span>append(
            <span style="color: #BA2121">&#39;montage -background white -geometry 100%&#39;</span> <span style="color: #666666">+</span>
            <span style="color: #BA2121">&#39; -tile 2x </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"> </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span> (png_files, method))
        image_commands<span style="color: #666666">.</span>append(
            <span style="color: #BA2121">&#39;convert -trim </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">.png </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span> (method, method))
        image_commands<span style="color: #666666">.</span>append(
            <span style="color: #BA2121">&#39;convert </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">.png -transparent white </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span>
            (method, method))
        image_commands<span style="color: #666666">.</span>append(
            <span style="color: #BA2121">&#39;pdftk </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"> output tmp.pdf&#39;</span> <span style="color: #666666">%</span> pdf_files)
        num_rows <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span style="color: #008000">round</span>(<span style="color: #008000">len</span>(dt_values)<span style="color: #666666">/2.0</span>))
        image_commands<span style="color: #666666">.</span>append(
            <span style="color: #BA2121">&#39;pdfnup --nup 2x</span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BA2121"> --outfile tmp.pdf tmp.pdf&#39;</span> <span style="color: #666666">%</span> num_rows)
        image_commands<span style="color: #666666">.</span>append(
            <span style="color: #BA2121">&#39;pdfcrop tmp.pdf </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">.pdf&#39;</span> <span style="color: #666666">%</span> method)

    <span style="color: #008000; font-weight: bold">for</span> cmd <span style="color: #AA22FF; font-weight: bold">in</span> image_commands:
        <span style="color: #008000; font-weight: bold">print</span> cmd
        failure <span style="color: #666666">=</span> os<span style="color: #666666">.</span>system(cmd)
        <span style="color: #008000; font-weight: bold">if</span> failure:
            <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Command failed:&#39;</span>, cmd; sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)

    <span style="color: #408080; font-style: italic"># Remove the files generated above and by model.py</span>
    <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">glob</span> <span style="color: #008000; font-weight: bold">import</span> glob
    filenames <span style="color: #666666">=</span> glob(<span style="color: #BA2121">&#39;*_*.png&#39;</span>) <span style="color: #666666">+</span> glob(<span style="color: #BA2121">&#39;*_*.pdf&#39;</span>) <span style="color: #666666">+</span> glob(<span style="color: #BA2121">&#39;tmp*.pdf&#39;</span>)
    <span style="color: #008000; font-weight: bold">for</span> filename <span style="color: #AA22FF; font-weight: bold">in</span> filenames:
        os<span style="color: #666666">.</span>remove(filename)

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    run_experiments(I<span style="color: #666666">=1</span>, a<span style="color: #666666">=2</span>, T<span style="color: #666666">=5</span>)
    plt<span style="color: #666666">.</span>show()  <span style="color: #408080; font-style: italic"># at the end of the program</span>
</pre></div>
<p>
We may comment upon many useful constructs in this script:

<ul>
 <li> <code>[float(arg) for arg in sys.argv[1:]]</code> builds a list of real numbers
   from all the command-line arguments.</li>
 <li> <code>failure = os.system(cmd)</code> runs an operating system command, e.g.,
   another program. The execution is successful only if <code>failure</code> is zero.</li>
 <li> Unsuccessful execution usually makes it meaningless to continue
   the program, and therefore we abort the program with <code>sys.exit(1)</code>.
   Any argument different from 0 signifies to the computer's operating system
   that our program stopped with a failure.</li>
 <li> <code>['%s_%s.png' % (method, dt) for dt in dt_values]</code> builds a list of
   filenames from a list of numbers (<code>dt_values</code>).</li>
 <li> All <code>montage</code>, <code>convert</code>, <code>pdftk</code>, <code>pdfnup</code>, and <code>pdfcrop</code>
   commands for creating
   composite figures are stored in a
   list and later executed in a loop.</li>
 <li> <code>glob('*_*.png')</code> returns a list of the names of all files in the
   current directory where the filename matches the <a href="http://en.wikipedia.org/wiki/Glob_(programming)" target="_self">Unix wildcard notation</a>
   <code>*_*.png</code> (meaning any text, underscore, any text, and then <code>.png</code>).</li>
 <li> <code>os.remove(filename)</code> removes the file with name <code>filename</code>.</li>
</ul>

<h2 id="softeng1:exper:report">Making a report</h2>

<p>
The results of running computer experiments are best documented in a
little report containing the problem to be solved, key code segments,
and the plots from a series of experiments. At least the part of the
report containing the plots should be automatically generated by the
script that performs the set of experiments, because in that script we
know exactly which input data that were used to generate a specific
plot, thereby ensuring that each figure is connected to the
right data. Take a look at an
example at <a href="http://hplgit.github.io/teamods/writing_reports/sphinx-cloud/" target="_self"><tt>http://hplgit.github.io/teamods/writing_reports/sphinx-cloud/</tt></a>  to see what we have in
mind.

<h3 id="___sec44">Plain HTML </h3>

<p>
Scientific reports can be written in a variety of formats. Here we
begin with the <a href="http://en.wikipedia.org/wiki/HTML" target="_self">HTML</a> format
which allows efficient viewing of all the experiments in any web
browser. The program
<a href="http://hplgit.github.io/teamods/writing_reports/report_generation/exper1_html.py" target="_self"><tt>exper1_html.py</tt></a> calls
<code>exper1.py</code> to perform the experiments and then runs
statements for creating an HTML file with a summary, a
section on the mathematical problem, a section on the numerical
method, a section on the <code>solver</code> function implementing the
method, and a section with subsections containing figures that show
the results of experiments where \( \Delta t \) is varied for
\( \theta=0,0.5,1 \). The mentioned
Python file contains all the details for writing
this <a href="http://hplgit.github.io/teamods/writing_reports/_static/report_html.html.html" target="_self">HTML report</a>.
You can view the report on <a href="http://hplgit.github.io/teamods/writing_reports/_static/report_html.html" target="_self"><tt>http://hplgit.github.io/teamods/writing_reports/_static/report_html.html</tt></a>.

<h3 id="___sec45">HTML with MathJax </h3>

<p>
Scientific reports usually need mathematical formulas and hence
mathematical typesetting. In plain HTML, as used in the
<code>exper1_html.py</code> file, we have to use just the keyboard
characters to write mathematics. However, there is an extension to
HTML, called <a href="http://www.mathjax.org/" target="_self">MathJax</a>, which allows
formulas and equations to be typeset with LaTeX syntax and nicely
rendered in web browsers, see Figure
<a href="#softeng1:exper:report:fig:mathjax">4</a>.  A relatively small subset of
LaTeX environments is supported, but the syntax for formulas is quite
rich. Inline formulas are look like <code>\( u'=-au \)</code> while equations are
surrounded by <code>$$</code> signs.  Inside such signs, one can use <code>\[ u'=-au
\]</code> for unnumbered equations, or <code>\begin{equation}</code> and
<code>\end{equation}</code> surrounding <code>u'=-au</code> for numbered equations, or
<code>\begin{align}</code> and <code>\end{align}</code> for multiple aligned equations.  You
need to be familiar with <a href="http://en.wikibooks.org/wiki/LaTeX/Mathematics" target="_self">mathematical typesetting in LaTeX</a>.

<p>
The file <a href="http://hplgit.github.io/teamods/writing_reports/report_generation/exper1_html.py" target="_self"><tt>exper1_mathjax.py</tt></a> contains all the
details for turning the previous plain HTML report into <a href="http://hplgit.github.io/teamods/writing_reports/_static/report_mathjax.html" target="_self">web pages
with nicely typeset mathematics</a>.  The
<a href="http://hplgit.github.io/teamods/writing_reports/_static/report_mathjax.html.html" target="_self">corresponding HTML code</a> be studied
to see all details of the mathematical typesetting.

<p>
<center> <!-- figure -->
<hr class="figure">
<center><p class="caption">Figure 4:  Report in HTML format with MathJax. <div id="softeng1:exper:report:fig:mathjax"></div> </p></center>
<p><img src="fig-softeng1/report_mathjax.png" align="bottom" width=600></p>
</center>

<h3 id="___sec46">LaTeX </h3>

<p>
<!-- "http://en.wikibooks.org/wiki/LaTeX" -->

<p>
The <em>de facto</em> language for mathematical typesetting and scientific
report writing is <a href="http://en.wikipedia.org/wiki/LaTeX" target="_self">LaTeX</a>. A
number of very sophisticated packages have been added to the language
over a period of three decades, allowing very fine-tuned layout and
typesetting. For output in the <a href="http://hplgit.github.io/teamods/writing_reports/_static/report.pdf" target="_self">PDF format</a>, see Figure
<a href="#softeng1:exper:report:fig:latex">5</a> for an example, LaTeX is the
definite choice when it comes to quality. The LaTeX language used to
write the reports has typically a lot of commands involving
<a href="http://hplgit.github.io/teamods/writing_reports/_static/report.tex.html" target="_self">backslashes and braces</a>.  For output on the web,
using HTML (and not the PDF directly in the browser window), LaTeX
struggles with delivering high quality typesetting. Other tools,
especially Sphinx, give better results and can also produce
nice-looking PDFs.  The file <a href="http://hplgit.github.io/teamods/writing_reports/report_generation/exper1_latex.py" target="_self"><tt>exper1_latex.py</tt></a> shows how to
generate the LaTeX source from a program.

<p>
<center> <!-- figure -->
<hr class="figure">
<center><p class="caption">Figure 5:  Report in PDF format generated from LaTeX source. <div id="softeng1:exper:report:fig:latex"></div> </p></center>
<p><img src="fig-softeng1/report_latexpdf.png" align="bottom" width=600></p>
</center>

<h3 id="___sec47">Sphinx </h3>

<p>
<!-- give pointers to source pages -->

<p>
<a href="http://sphinx.pocoo.org/" target="_self">Sphinx</a> is a typesetting language with
similarities to HTML and LaTeX, but with much less tagging. It has
recently become very popular for software documentation and
mathematical reports. Sphinx can utilize LaTeX for mathematical
formulas and equations (via MathJax or PNG images). Unfortunately, the
subset of LaTeX mathematics supported is less than in full MathJax (in
particular, numbering of multiple equations in an <code>align</code> type
environment is not supported).  The <a href="http://hplgit.github.io/teamods/writing_reports/_static/report_sphinx.rst.html" target="_self">Sphinx syntax</a> is an extension of
the reStructuredText language. An attractive feature of Sphinx is its
rich support for <a href="http://hplgit.github.io/teamods/writing_reports/_static/sphinx-cloud/index.html" target="_self">fancy layout of web pages</a>. In particular,
Sphinx can easily be combined with various layout <em>themes</em> that give a
certain look and feel to the web site and that offers table of
contents, navigation, and search facilities, see Figure
<a href="#softeng1:exper:report:fig:sphinx">6</a>.

<p>
<center> <!-- figure -->
<hr class="figure">
<center><p class="caption">Figure 6:  Report in HTML format generated from Sphinx source. <div id="softeng1:exper:report:fig:sphinx"></div> </p></center>
<p><img src="fig-softeng1/report_sphinx.png" align="bottom" width=600></p>
</center>

<h3 id="___sec48">Markdown </h3>

<p>
A recently popular format for easy writing of web pages is
<a href="http://daringfireball.net/projects/markdown/" target="_self">Markdown</a>.
Text is written very much like one would do in email, using
spacing and special characters to naturally format the code
instead of heavily tagging the text as in LaTeX and HTML.
With the tool <a href="http://johnmacfarlane.net/pandoc/" target="_self">Pandoc</a> one
can go from Markdown to a variety of formats.
HTML is a common output format, but LaTeX, epub, XML,
OpenOffice, MediaWiki, and MS Word are some other possibilities.

<h3 id="___sec49">Wiki formats </h3>

<p>
A range of wiki formats are popular for creating notes on the web,
especially documents which allow groups of people to edit and add
content. Apart from <a href="http://www.mediawiki.org/wiki/MediaWiki" target="_self">MediaWiki</a> (the wiki format used for
Wikipedia), wiki formats have no support for mathematical typesetting
and also limited tools for displaying computer code in nice ways.
Wiki formats are therefore less suitable for scientific reports compared
to the other formats mentioned here.

<h3 id="___sec50">DocOnce </h3>

<p>
Since it is difficult to choose the right tool or format for writing a
scientific report, it is advantageous to write the content in a format
that easily translates to LaTeX, HTML, Sphinx, Markdown, and various
wikis. <a href="https://github.com/hplgit/doconce" target="_self">DocOnce</a> is such a
tool. It is similar to Pandoc, but offers some special convenient
features for writing about mathematics and programming.  The <a href="http://hplgit.github.io/teamods/writing_reports/_static/report.do.txt.html" target="_self">tagging
is modest</a>, somewhere
between LaTeX and Markdown.  The program <a href="http://hplgit.github.io/teamods/writing_reports/report_generation/exper1_do.py" target="_self"><tt>exper1_do.py</tt></a> demonstrates how
to generate (and write) DocOnce code for a report.

<h3 id="___sec51">Worked example </h3>

<p>
The HTML, LaTeX (PDF), Sphinx, and DocOnce formats for the scientific
report whose content is outlined above, are exemplified
with source codes and results at the
web pages associated with this teaching material:
<a href="http://hplgit.github.io/teamods/writing_reports" target="_self"><tt>http://hplgit.github.io/teamods/writing_reports</tt></a>.

<p>
<!-- project with exploring instability (help with matplotlib contour plots, and maybe show such a plot) -->

<h2 id="softeng1:exper:github">Publishing a complete project</h2>

<p>
A report documenting scientific investigations should be accompanied by
all the software and data used for the investigations so that others
have a possibility to redo the work and assess the qualify of the results.
This possibility is important for <em>reproducible research</em> and
hence reaching reliable scientific conclusions.

<p>
One way of documenting a complete project is to make a directory tree
with all relevant files. Preferably, the tree is published at
some project hosting site like <a href="http://hplgit.github.com/teamods/bitgit/html/" target="_self">Bitbucket or GitHub</a> so that others can download it
as a tarfile, zipfile, or clone the files directly using the Git version control
system.
For the investigations outlined in the section <a href="#softeng1:exper:report">Making a report</a>,
we can create a directory tree with files
<p>

<!-- code=text typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">setup.py
./src:
   model.py
./doc:
   ./src:
      exper1_mathjax.py
      make_report.sh
      run.sh
   ./pub:
      report.html
</pre></div>
<p>
The <code>src</code> directory holds source code (modules) to be reused in other projects,
the <code>setup.py</code> builds and installs such software,
the <code>doc</code> directory contains the documentation, with <code>src</code> for the
source of the documentation and <code>pub</code> for ready-made, published documentation.
The <code>run.sh</code> file is a simple Bash script listing the <code>python</code> command
we used to run <code>exper1_mathjax.py</code> to generate the experiments and
the <code>report.html</code> file.

<p>
<!-- Point to DocOnce version -->

<h1 id="___sec53">Exercises </h1>

<p>
<!-- --- begin exercise --- -->

<h2 id="softeng1:exer:derivative">Problem 1: Make a tool for differentiating curves</h2>

<p>
Suppose we have a curve specified through a set
of discrete coordinates \( (x_i,y_i) \), \( i=0,\ldots,n \), where the \( x_i \)
values are uniformly distributed with spacing \( \Delta x \): \( x_i=\Delta x \).
The derivative of this curve, defined as a new curve with points
\( (x_i, d_i) \), can be computed via finite differences:

$$
\begin{align}
d_0 &= \frac{y_1-y_0}{\Delta x},\\ 
d_i &= \frac{y_{i+1}-y_{i-1}}{2\Delta x},\quad i=1,\ldots,n-1,\\ 
d_n &= \frac{y_n-y_{n-1}}{\Delta x}\tp
\end{align}
$$


<p>
<b>a)</b>
Write a function
<code>differentiate(x, y)</code> for differentiating a curve
   with coordinates in the arrays <code>x</code> and <code>y</code>, using the
   formulas above. The function should return the coordinate arrays
of the resulting differentiated curve.

<p>
<b>b)</b>
Write a test function for the function in a).

<p>
<b>c)</b>
Start with a curve corresponding to \( y=\sin(\pi x) \) and \( n+1 \)
points in \( [0,1] \). Apply <code>differentiate</code> four times and plot the
resulting curve and the exact \( y=\sin\pi x \) for \( n=6, 11, 21, 41 \).

<p>
<!-- Using a 2nd-order backward formula at x=1 does not improve the -->
<!-- results much, one gets large errors at the end points. -->

<p>
Filename: <code>curvediff.py</code>.

<p>
<!-- --- end exercise --- -->

<p>
<!-- --- begin exercise --- -->

<h2 id="softeng1:exer:integral:flat">Problem 2: Make solid software for the Trapezoidal rule</h2>

<p>
An integral

$$ \int_a^b f(x)dx $$

can be numerically approximated by the Trapezoidal rule,

$$ \int_a^b f(x)dx \approx \frac{h}{2}(f(a) + f(b)) + h\sum_{i=1}^{n-1} f(x_i),
$$

where \( x_i \) is a set of uniformly spaced points in \( [a,b] \):

$$ h = \frac{b-a}{n},\quad x_i=a + ih,\ i=1,\ldots,n-1\tp $$


<p>
Somebody has used this rule to compute the integral \( \int_0^\pi sin^2x dx \):

<p>

<!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">math</span> <span style="color: #008000; font-weight: bold">import</span> pi, sin
n <span style="color: #666666">=</span> <span style="color: #666666">20</span>
h <span style="color: #666666">=</span> pi<span style="color: #666666">/</span>n
I <span style="color: #666666">=</span> <span style="color: #666666">0</span>
<span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">1</span>, n):
    I <span style="color: #666666">+=</span> sin(i<span style="color: #666666">*</span>h)<span style="color: #666666">**2</span>
<span style="color: #008000; font-weight: bold">print</span> I
</pre></div>
<p>
<b>a)</b>
The &quot;flat&quot; implementation above suffers from three serious flaws:

<ol>
<li> A general numerical algorithm (the Trapezoidal rule) is implemented
   in a specialized form where the formula for \( f \) is inserted directly
   into the code for the general integration formula.</li>
<li> A general numerical algorithm is not encapsulated as a general
   function, with appropriate parameters, which can be reused
   across a wide range of applications.</li>
<li> The lazy programmer dropped the first terms in the general formula
   since \( \sin(0)=\sin(\pi)=0 \).</li>
</ol>

Write a function <code>trapezoidal</code> that fixes these flaws.
Place the function in a module <code>trapezoidal</code>.

<p>
<b>b)</b>
Write a test function <code>test_trapezoidal</code>. Call the test function
explicitly to check that it works. Remove the call and run pytest
on the module:

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; py.test -s -v trapezoidal
</pre></div>
<p>
<!-- --- begin hint in exercise --- -->

<p>
<b>Hint.</b>
Note that even if you know the value of the integral, you do not know
the error in the approximation produced by the Trapezoidal rule.
However, the Trapezoidal rule will integrate linear functions,
and piecewise linear functions, with discontinuities at the \( x_i \)
points, exactly (i.e., to machine precision). Base a test function
on such linear functions \( f(x) \).

<p>
<!-- --- end hint in exercise --- -->

<p>
<b>c)</b>
Add functionality for computing \( \int_a^b f(x)dx \) by providing
\( f \), \( a \), \( b \), and \( n \) as positional command-line arguments:

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python trapezoidal.py &#39;sin(x)**2&#39; 0 pi 20
</pre></div>
<p>
Note that the <code>trapezoidal.py</code> must still be a valid module file, so the
interpretation of command-line data and computation of the integral
must be performed from calls in a test block.

<p>
<!-- --- begin hint in exercise --- -->

<p>
<b>Hint.</b>
To translate a string formula on the command line, like <code>sin(x)**2</code>,
into a Python function, you can wrap a function declaration around
the formula and run <code>exec</code> on the string to turn it into live Python code:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">math</span><span style="color: #666666">,</span> <span style="color: #0000FF; font-weight: bold">sys</span>
formula <span style="color: #666666">=</span> sys<span style="color: #666666">.</span>argv[<span style="color: #666666">1</span>]
f_code <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;&quot;</span>
<span style="color: #BA2121">def f(x):</span>
<span style="color: #BA2121">    return </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"></span>
<span style="color: #BA2121">&quot;&quot;&quot;</span> <span style="color: #666666">%</span> formula
<span style="color: #008000; font-weight: bold">exec</span>(code, math<span style="color: #666666">.</span>__dict__)
</pre></div>
<p>
The result is the same as if we had hardcoded

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">f</span>(x):
    <span style="color: #008000; font-weight: bold">return</span> sin(x)<span style="color: #666666">**2</span>
</pre></div>
<p>
in the program. Note that <code>exec</code> needs the namespace
<code>math.__dict__</code>, i.e., all names in the <code>math</code> module, such that
it understands <code>sin</code> and other mathematical functions.
Similarly, to allow \( a \) and \( b \) to be <code>math</code> values like <code>pi</code>,
do

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">a = eval(sys.argv[2], math.__dict__)
b = eval(sys.argv[2], math.__dict__)
</pre></div>
<p>
<!-- --- end hint in exercise --- -->

<p>
<b>d)</b>
Write a test function for verifying the implementation of the
reading data from the command line.

<p>
Filename: <code>trapezoidal.py</code>.

<p>
<!-- --- end exercise --- -->

<p>
<!-- --- begin exercise --- -->

<h2 id="softeng1:exer:integral:flat2">Problem 3: Implement classes for the Trapezoidal rule</h2>

<p>
We consider the same problem setting as in <a href="#softeng1:exer:integral:flat">Problem 2: Make solid software for the Trapezoidal rule</a>. Make a module with a class <code>Problem</code>
representing the mathematical problem to be solved and a class
<code>Solver</code> representing the solution method.  The rest of the
functionality of the module, including test functions and reading data
from the command line, should be as in <a href="#softeng1:exer:integral:flat">Problem 2: Make solid software for the Trapezoidal rule</a>.
Filename: <code>trapezoidal_class.py</code>.

<p>
<!-- --- end exercise --- -->

<p>
<!-- --- begin exercise --- -->

<h2 id="softeng1:exer:doctest1">Problem 4: Write a doctest</h2>

<p>
Type in the following program and equip the <code>roots</code> function with a doctest:

<p>

<!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">sys</span>
<span style="color: #408080; font-style: italic"># This sqrt(x) returns real if x&gt;0 and complex if x&lt;0</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy.lib.scimath</span> <span style="color: #008000; font-weight: bold">import</span> sqrt

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">roots</span>(a, b, c):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Return the roots of the quadratic polynomial</span>
<span style="color: #BA2121; font-style: italic">    p(x) = a*x**2 + b*x + c.</span>

<span style="color: #BA2121; font-style: italic">    The roots are real or complex objects.</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    q <span style="color: #666666">=</span> b<span style="color: #666666">**2</span> <span style="color: #666666">-</span> <span style="color: #666666">4*</span>a<span style="color: #666666">*</span>c
    r1 <span style="color: #666666">=</span> (<span style="color: #666666">-</span>b <span style="color: #666666">+</span> sqrt(q))<span style="color: #666666">/</span>(<span style="color: #666666">2*</span>a)
    r2 <span style="color: #666666">=</span> (<span style="color: #666666">-</span>b <span style="color: #666666">-</span> sqrt(q))<span style="color: #666666">/</span>(<span style="color: #666666">2*</span>a)
    <span style="color: #008000; font-weight: bold">return</span> r1, r2

a, b, c <span style="color: #666666">=</span> [<span style="color: #008000">float</span>(arg) <span style="color: #008000; font-weight: bold">for</span> arg <span style="color: #AA22FF; font-weight: bold">in</span> sys<span style="color: #666666">.</span>argv[<span style="color: #666666">1</span>:]]
<span style="color: #008000; font-weight: bold">print</span> roots(a, b, c)
</pre></div>
<p>
Make sure to test both real and complex roots.
Write out numbers with 14 digits or less.
Filename: <code>doctest_roots.py</code>.

<p>
<!-- --- end exercise --- -->

<p>
<!-- --- begin exercise --- -->

<h2 id="softeng1:exer:nosetest1">Problem 5: Write a nose test</h2>

<p>
Make a test function for the <code>roots</code> function in
<a href="#softeng1:exer:doctest1">Problem 4: Write a doctest</a>.
Filename: <code>test_roots.py</code>.

<p>
<!-- --- end exercise --- -->

<p>
<!-- --- begin exercise --- -->

<h2 id="softeng1:exer:class:dts">Exercise 6: Make use of a class implementation</h2>

<p>
Implement the <code>experiment_compare_dt</code> function from <code>decay.py</code>
using class <code>Problem</code> and class <code>Solver</code> from
the section <a href="#softeng1:prog:se:class">Classes for problem and solution method</a>.
The parameters <code>I</code>, <code>a</code>, <code>T</code>, the scheme name, and a series of
<code>dt</code> values should be read from the command line.
Filename: <code>experiment_compare_dt_class.py</code>.

<p>
<!-- --- end exercise --- -->

<p>
<p>
<!-- navigation buttons at the bottom of the page -->
<ul class="pager">
  <li class="next">
    <a href="._main_softeng1001.html">Next &rarr;</a>
  </li>
</ul>
<!-- ------------------- end of main content --------------- -->

</div>  <!-- end container -->
<!-- include javascript, jQuery *first* -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>

<!-- Bootstrap footer
<footer>
<a href="http://..."><img width="250" align=right src="http://..."></a>
</footer>
-->


</body>
</html>
    

